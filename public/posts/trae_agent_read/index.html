<!doctype html><html lang=en><head><meta charset=utf-8><meta name=description content="Author: Lyeka <augustr2017@163.com>"><title>Lyeka
| Trae Agent 源码阅读</title><meta name=author content="map[email:augustr2017@163.com name:Lyeka]"><meta name=description content><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon href=/favicon_io/favicon.ico type=image/x-icon><link rel=icon href=/favicon_io/favicon-16x16.png size=16x16 type=image/png><link rel=icon href=/favicon_io/favicon-32x32.png size=32x32 type=image/png><link rel=preload type=text/css href=/css/rose-pine.min.css integrity as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet type=text/css href=/css/rose-pine.min.css integrity></noscript><link rel=preload type=text/css href="/css/toigian.min.f18ce5d96459613fd8b5e153269973c8d7855f961ddd0d077d526b4226da12bc.css" integrity="sha256-8Yzl2WRZYT/YteFTJplzyNeFX5Yd3Q0HfVJrQibaErw=" as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet type=text/css href="/css/toigian.min.f18ce5d96459613fd8b5e153269973c8d7855f961ddd0d077d526b4226da12bc.css" integrity="sha256-8Yzl2WRZYT/YteFTJplzyNeFX5Yd3Q0HfVJrQibaErw="></noscript><link rel=stylesheet type=text/css href="/css/light.min.75b8f6206f0794f8c7268b48c912aee56c33227a8b4fe2240046195c7e5b3ac3.css" integrity="sha256-dbj2IG8HlPjHJotIyRKu5WwzInqLT+IkAEYZXH5bOsM="><link rel=stylesheet type=text/css href="/css/dark.min.7ea96dfb503e6c18ad26e70c3e10e09691c711ce3a0f47fa588981348083cb5a.css" integrity="sha256-fqlt+1A+bBitJucMPhDglpHHEc46D0f6WImBNICDy1o="><script>localStorage.theme==="dark"||!("theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark")</script><script async defer src=/js/main.dfa968b06ebe7fb755eb156f7296445f20bd5ca0c82aa2eb755b1bfac4e2f294676471cf7670590073c364901a0dd5dc4b4c7b83f7a4a3c3b081f085c78fa1de.js integrity="sha512-36losG6+f7dV6xVvcpZEXyC9XKDIKqLrdVsb+sTi8pRnZHHPdnBZAHPDZJAaDdXcS0x7g/eko8OwgfCFx4+h3g=="></script><script src=https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js></script><script>mermaid.initialize({startOnLoad:!0,securityLevel:"loose"})</script><style>:root{--content-width:48rem}@media(min-width:1280px){:root{--content-width:48rem}}</style><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;700&display=swap" rel=stylesheet><link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&family=Noto+Serif+SC:wght@200..900&family=ZCOOL+XiaoWei&display=swap" rel=stylesheet><link href="https://fonts.googleapis.com/css2?family=LXGW+WenKai+Mono+TC&family=Montserrat:ital,wght@0,100..900;1,100..900&family=Noto+Serif+SC:wght@200..900&family=ZCOOL+XiaoWei&display=swap" rel=stylesheet><style>:root{--font-sans:"LXGW WenKai Mono TC", "ZCOOL XiaoWei", "Songti SC", "SimSun", "NSimSun", "Noto Serif SC", serif;--font-mono:"Berkeley Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}</style></head><body><header style=--layer:10><div aria-hidden=true class="absolute top-[-1000px] left-0 z-[calc(var(--layer)+1)] h-[calc(1000px+var(--page-top))] w-full bg-base"></div><div class="fixed top-0 left-0 z-[var(--layer)] flex h-header-height w-full items-center border-b px-page-gutter before:absolute before:inset-0 before:z-[-1] before:bg-base [@supports(backdrop-filter:blur(0))]:before:bg-base [@supports(backdrop-filter:blur(0))]:before:backdrop-blur-md"><div class="lowercase italic mx-auto flex w-full max-w-content items-center justify-between"><nav class=mr-3><ol class="flex text-md items-center"><li><a href=/ class="text-muted focus:underline focus:outline-none pr-1 whitespace-nowrap">Lyeka</a></li><li class="text-muted focus:underline focus:outline-none pr-1 whitespace-nowrap">/</li><li><a href=/posts/ class="text-muted focus:underline focus:outline-none pr-1 whitespace-nowrap">Posts</a></li><li class="text-muted focus:underline focus:outline-none pr-1 whitespace-nowrap">/</li><li><a href=/posts/trae_agent_read/ class="focus:underline focus:outline-none font-bold pr-1 hidden md:block">Trae Agent 源码阅读</a></li></ol></nav><nav class=ml-3><ul class="flex text-md whitespace-nowrap"><li class=pl-2><a href=/reading class="tracking-wide hover:underline">/Read</a></li><li class=pl-2><a href=/posts class="tracking-wide hover:underline">/Posts</a></li><li class=pl-2><a href=/about class="tracking-wide hover:underline">/About</a></li></ul></nav></div></div></header><main class="flex justify-center px-page-gutter py-page-top"><div class="min-h-content w-full max-w-content space-y-10 sm:space-y-20"><div class="lowercase italic mx-auto flex w-full max-w-content items-center justify-between"><nav class=mr-3><ol class="flex text-md items-center"><li><a href=/ class="text-muted focus:underline focus:outline-none pr-1 whitespace-nowrap">Lyeka</a></li><li class="text-muted focus:underline focus:outline-none pr-1 whitespace-nowrap">/</li><li><a href=/posts/ class="text-muted focus:underline focus:outline-none pr-1 whitespace-nowrap">Posts</a></li><li class="text-muted focus:underline focus:outline-none pr-1 whitespace-nowrap">/</li><li><a href=/posts/trae_agent_read/ class="focus:underline focus:outline-none font-bold pr-1 hidden md:block">Trae Agent 源码阅读</a></li></ol></nav><nav class=ml-3><ul class="flex text-md whitespace-nowrap"><li class=pl-2><a href=/reading class="tracking-wide hover:underline">/Read</a></li><li class=pl-2><a href=/posts class="tracking-wide hover:underline">/Posts</a></li><li class=pl-2><a href=/about class="tracking-wide hover:underline">/About</a></li></ul></nav></div><article><h1>Trae Agent 源码阅读</h1><time datetime=2025/09/26 class="mr-1 text-sm italic tabular-nums text-muted">2025/09/26&nbsp;</time><div id=toc><details open><summary>Table of contents</summary><div id=toc-list><nav id=TableOfContents><ol><li><a href=#项目概览>项目概览</a></li><li><a href=#核心流程>核心流程</a><ol><li><a href=#状态转换>状态转换</a></li></ol></li><li><a href=#工具>工具</a><ol><li><a href=#ckg-代码知识图谱>CKG 代码知识图谱</a><ol><li><a href=#构建逻辑>构建逻辑</a></li></ol></li><li><a href=#bash>Bash</a></li></ol></li></ol></nav></div></details></div><div class=content><blockquote class="my-5 p-4 rounded border-solid border-2 border-foam">本文分析基于 Git commit 2cb657823bc5f9bdf276a69d2bcdd60ec389de46 版本</blockquote><h2 id=项目概览>项目概览</h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>trae-agent/
</span></span><span class=line><span class=cl>├── trae_agent/                       <span class=c1># 核心包目录</span>
</span></span><span class=line><span class=cl>│   ├── agent/                        <span class=c1># Agent核心逻辑</span>
</span></span><span class=line><span class=cl>│   │   ├── agent_basics.py           <span class=c1># 基础数据结构 (AgentState, AgentStep)</span>
</span></span><span class=line><span class=cl>│   │   ├── base_agent.py             <span class=c1># 抽象基类 (ReAct循环逻辑)</span>
</span></span><span class=line><span class=cl>│   │   ├── trae_agent.py             <span class=c1># 具体实现 (软件工程专用)</span>
</span></span><span class=line><span class=cl>│   │   ├── agent.py                  <span class=c1># 包装器 (外观模式)</span>
</span></span><span class=line><span class=cl>│   │   └── docker_manager.py         <span class=c1># Docker环境管理</span>
</span></span><span class=line><span class=cl>│   │
</span></span><span class=line><span class=cl>│   ├── tools/                        <span class=c1># 工具集合</span>
</span></span><span class=line><span class=cl>│   │   ├── base.py                   <span class=c1># 工具基类和接口</span>
</span></span><span class=line><span class=cl>│   │   ├── bash_tool.py              <span class=c1># Shell命令执行</span>
</span></span><span class=line><span class=cl>│   │   ├── edit_tool.py              <span class=c1># 文件编辑工具</span>
</span></span><span class=line><span class=cl>│   │   ├── json_edit_tool.py         <span class=c1># JSON编辑工具</span>
</span></span><span class=line><span class=cl>│   │   ├── task_done_tool.py         <span class=c1># 任务完成工具</span>
</span></span><span class=line><span class=cl>│   │   ├── sequential_thinking_tool.py <span class=c1># 结构化思考</span>
</span></span><span class=line><span class=cl>│   │   ├── mcp_tool.py               <span class=c1># MCP协议工具</span>
</span></span><span class=line><span class=cl>│   │   └── ckg/                      <span class=c1># 代码知识图谱</span>
</span></span><span class=line><span class=cl>│   │
</span></span><span class=line><span class=cl>│   ├── utils/                        <span class=c1># 工具类模块</span>
</span></span><span class=line><span class=cl>│   │   ├── llm_clients/              <span class=c1># LLM客户端</span>
</span></span><span class=line><span class=cl>│   │   │   ├── llm_client.py         <span class=c1># 统一客户端接口</span>
</span></span><span class=line><span class=cl>│   │   │   ├── anthropic_client.py   <span class=c1># Claude集成</span>
</span></span><span class=line><span class=cl>│   │   │   ├── openai_client.py      <span class=c1># GPT集成</span>
</span></span><span class=line><span class=cl>│   │   │   ├── google_client.py      <span class=c1># Gemini集成</span>
</span></span><span class=line><span class=cl>│   │   │   └── ...                   <span class=c1># 其他LLM提供商</span>
</span></span><span class=line><span class=cl>│   │   │
</span></span><span class=line><span class=cl>│   │   ├── cli/                      <span class=c1># 命令行界面</span>
</span></span><span class=line><span class=cl>│   │   │   ├── console_factory.py    <span class=c1># 控制台工厂</span>
</span></span><span class=line><span class=cl>│   │   │   ├── simple_console.py     <span class=c1># 简单文本界面</span>
</span></span><span class=line><span class=cl>│   │   │   └── rich_console.py       <span class=c1># 富文本界面</span>
</span></span><span class=line><span class=cl>│   │   │
</span></span><span class=line><span class=cl>│   │   ├── config.py                 <span class=c1># 配置管理</span>
</span></span><span class=line><span class=cl>│   │   ├── trajectory_recorder.py    <span class=c1># 轨迹记录</span>
</span></span><span class=line><span class=cl>│   │   └── mcp_client.py             <span class=c1># MCP协议客户端</span>
</span></span><span class=line><span class=cl>│   │
</span></span><span class=line><span class=cl>│   ├── prompt/                       <span class=c1># 提示词管理</span>
</span></span><span class=line><span class=cl>│   │   └── agent_prompt.py           <span class=c1># Agent提示词</span>
</span></span><span class=line><span class=cl>│   │
</span></span><span class=line><span class=cl>│   ├── cli.py                        <span class=c1># 命令行入口</span>
</span></span><span class=line><span class=cl>│   └── dist/                         <span class=c1># 分发工具</span>
</span></span><span class=line><span class=cl>│
</span></span><span class=line><span class=cl>├── evaluation/                       <span class=c1># 评估框架</span>
</span></span><span class=line><span class=cl>│   ├── run_evaluation.py             <span class=c1># SWE-bench评估脚本</span>
</span></span><span class=line><span class=cl>│   ├── utils.py                      <span class=c1># 评估工具函数</span>
</span></span><span class=line><span class=cl>│   └── patch_selection/              <span class=c1># 补丁选择评估</span>
</span></span><span class=line><span class=cl>│
</span></span><span class=line><span class=cl>├── tests/                            <span class=c1># 测试套件</span>
</span></span><span class=line><span class=cl>│   ├── agent/                        <span class=c1># Agent测试</span>
</span></span><span class=line><span class=cl>│   ├── tools/                        <span class=c1># 工具测试</span>
</span></span><span class=line><span class=cl>│   └── utils/                        <span class=c1># 工具类测试</span>
</span></span><span class=line><span class=cl>│
</span></span><span class=line><span class=cl>├── docs/                             <span class=c1># 文档</span>
</span></span><span class=line><span class=cl>│   ├── tools.md                      <span class=c1># 工具文档</span>
</span></span><span class=line><span class=cl>│   └── TRAJECTORY_RECORDING.md       <span class=c1># 轨迹记录文档</span>
</span></span><span class=line><span class=cl>│
</span></span><span class=line><span class=cl>├── server/                           <span class=c1># FastAPI服务端 (可选)</span>
</span></span><span class=line><span class=cl>│
</span></span><span class=line><span class=cl>├── pyproject.toml                    <span class=c1># Python项目配置</span>
</span></span><span class=line><span class=cl>├── trae_config.yaml.example          <span class=c1># 配置模板</span>
</span></span><span class=line><span class=cl>└── README.md                         <span class=c1># 项目说明</span>
</span></span></code></pre></div><p>关系图谱<div class=mermaid align=center>graph TB
%% 外部接口层
CLI[CLI Interface<br>trae_agent/cli.py] --> Agent[Agent<br>trae_agent/agent/agent.py]
Server[FastAPI Server<br>server/] --> Agent
%% 代理层
Agent --> TraeAgent[TraeAgent<br>trae_agent/agent/trae_agent.py]
Agent --> BaseAgent[BaseAgent<br>trae_agent/agent/base_agent.py]
TraeAgent -.-> BaseAgent
%% 配置层
Config[Configuration<br>trae_agent/utils/config.py] --> Agent
Config --> TraeAgent
%% LLM 客户端层
BaseAgent --> LLMClient[LLM Client<br>trae_agent/utils/llm_clients/]
LLMClient --> Anthropic[anthropic_client.py]
LLMClient --> OpenAI[openai_client.py]
LLMClient --> Google[google_client.py]
LLMClient --> Ollama[ollama_client.py]
LLMClient --> Azure[azure_client.py]
LLMClient --> Doubao[doubao_client.py]
LLMClient --> OpenRouter[openrouter_client.py]
%% 工具执行层
BaseAgent --> ToolExecutor[Tool Executor<br>trae_agent/tools/base.py]
BaseAgent --> DockerToolExecutor[Docker Tool Executor<br>trae_agent/tools/docker_tool_executor.py]
ToolExecutor --> ToolRegistry[Tools Registry<br>trae_agent/tools/__init__.py]
DockerToolExecutor --> ToolRegistry
%% 工具实现层
ToolRegistry --> BashTool[Bash Tool]
ToolRegistry --> EditTool[Text Editor Tool]
ToolRegistry --> JSONEditTool[JSON Edit Tool]
ToolRegistry --> ThinkingTool[Sequential Thinking Tool]
ToolRegistry --> TaskDoneTool[Task Done Tool]
ToolRegistry --> CKGTool[Code Knowledge Graph Tool]
%% MCP 工具层
TraeAgent --> MCPClient[MCP Client<br>trae_agent/utils/mcp_client.py]
MCPClient --> MCPTool[MCP Tools<br>trae_agent/tools/mcp_tool.py]
%% Docker 管理层
BaseAgent --> DockerManager[Docker Manager<br>trae_agent/agent/docker_manager.py]
%% 控制台层
Agent --> CLIConsole[CLI Console<br>trae_agent/utils/cli/]
CLIConsole --> SimpleConsole[Simple Console]
CLIConsole --> RichConsole[Rich Console]
%% 轨迹记录层
Agent --> TrajectoryRecorder[Trajectory Recorder<br>trae_agent/utils/trajectory_recorder.py]
%% 提示层
TraeAgent --> SystemPrompt[System Prompt<br>trae_agent/prompt/agent_prompt.py]
%% 评估层
Evaluation[Evaluation<br>evaluation/] --> Agent
Evaluation --> SWEBench[SWE-bench]
Evaluation --> SWEBenchLive[SWE-bench-Live]
Evaluation --> MultiSWEBench[Multi-SWE-bench]
%% 测试层
Tests[Tests<br>tests/] -.-> Agent
Tests -.-> ToolRegistry
Tests -.-> Config
%% 样式定义
classDef interface fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef core fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
classDef tools fill:#e8f5e8,stroke:#1b5e20,stroke-width:2px
classDef llm fill:#fff3e0,stroke:#e65100,stroke-width:2px
classDef utils fill:#f1f8e9,stroke:#33691e,stroke-width:2px
classDef eval fill:#fce4ec,stroke:#880e4f,stroke-width:2px
class CLI,Server interface
class Agent,TraeAgent,BaseAgent core
class ToolExecutor,DockerToolExecutor,ToolRegistry,BashTool,EditTool,JSONEditTool,ThinkingTool,TaskDoneTool,CKGTool,MCPTool tools
class LLMClient,Anthropic,OpenAI,Google,Ollama,Azure,Doubao,OpenRouter llm
class Config,CLIConsole,TrajectoryRecorder,DockerManager,MCPClient,SystemPrompt utils
class Evaluation,SWEBench,SWEBenchLive,MultiSWEBench,Tests eval</div></p><h2 id=核心流程>核心流程</h2><div class=mermaid align=center>sequenceDiagram
participant CLI
participant Agent
participant TraeAgent
participant LLMClient
participant ToolExecutor
participant CLIConsole
participant TrajectoryRecorder
Note over CLI,TrajectoryRecorder: 1. 初始化阶段
CLI->>Agent: create(agent_type, config, console)
Agent->>TraeAgent: new TraeAgent(config)
Agent->>CLIConsole: set_cli_console()
Agent->>TrajectoryRecorder: set_trajectory_recorder()
Note over CLI,TrajectoryRecorder: 2. 任务启动
CLI->>Agent: run(task, task_args)
Agent->>TraeAgent: new_task(task, extra_args)
TraeAgent->>TraeAgent: setup initial messages
TraeAgent->>TrajectoryRecorder: start_recording()
alt MCP 工具需要初始化
Agent->>TraeAgent: initialise_mcp()
TraeAgent->>TraeAgent: discover_mcp_tools()
end
Agent->>CLIConsole: print_task_details()
par 并行启动
Agent->>CLIConsole: start() [异步任务]
and
Agent->>TraeAgent: execute_task()
end
Note over CLI,TrajectoryRecorder: 3. 主执行循环
loop 最多 max_steps 次
TraeAgent->>CLIConsole: update_status(THINKING)
TraeAgent->>LLMClient: chat(messages, tools)
LLMClient-->>TraeAgent: llm_response
TraeAgent->>CLIConsole: update_status(response)
alt LLM 说任务完成
TraeAgent->>TraeAgent: llm_indicates_task_completed()
alt 真正完成
TraeAgent->>TraeAgent: _is_task_completed()
TraeAgent->>TraeAgent: set COMPLETED state
Note over TraeAgent: 跳出循环
else 实际未完成
TraeAgent->>TraeAgent: task_incomplete_message()
Note over TraeAgent: 继续循环
end
else LLM 要执行工具
TraeAgent->>CLIConsole: update_status(CALLING_TOOL)
alt 并行工具调用
TraeAgent->>ToolExecutor: parallel_tool_call()
else 串行工具调用
TraeAgent->>ToolExecutor: sequential_tool_call()
end
ToolExecutor-->>TraeAgent: tool_results
TraeAgent->>CLIConsole: update_status(tool_results)
opt 需要反思
TraeAgent->>TraeAgent: reflect_on_result()
TraeAgent->>CLIConsole: update_status(REFLECTING)
end
end
TraeAgent->>TrajectoryRecorder: record_agent_step()
TraeAgent->>CLIConsole: update_status(COMPLETED step)
end
Note over CLI,TrajectoryRecorder: 4. 清理阶段
TraeAgent->>ToolExecutor: close_tools()
TraeAgent->>TraeAgent: cleanup_mcp_clients()
TraeAgent-->>Agent: execution_result
Agent->>CLIConsole: 等待控制台任务完成
Agent-->>CLI: 返回执行结果
CLI->>CLI: 显示轨迹文件路径</div><p>Trae Agent 整体设计上采用了 ReAct 模式，当创建 Agent 实例并初始化资源后，开始在循环中执行任务，交替执行 LLM 推理、工具执行，失败反思步骤，直到任务完成。
任务的完成分为两步，一是解析 LLM 的 Response 中是否有任务结束标识（ 是否包含 <code>task_done</code> 等关键字），二是当必须有代码变更时，检查是否有除了 test 文件之外的的改动（TODO：什么情况下才必须要有代码变更？）。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@override</span>  
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>_is_task_completed</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>llm_response</span><span class=p>:</span> <span class=n>LLMResponse</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>  
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Enhanced task completion detection.&#34;&#34;&#34;</span>  
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>must_patch</span> <span class=o>==</span> <span class=s2>&#34;true&#34;</span><span class=p>:</span>  
</span></span><span class=line><span class=cl>        <span class=n>model_patch</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_git_diff</span><span class=p>()</span>  
</span></span><span class=line><span class=cl>        <span class=n>patch</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>remove_patches_to_tests</span><span class=p>(</span><span class=n>model_patch</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>patch</span><span class=o>.</span><span class=n>strip</span><span class=p>():</span>  
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>False</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>remove_patches_to_tests</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>model_patch</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>  
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;  
</span></span></span><span class=line><span class=cl><span class=s2>    Remove any changes to the tests directory from the provided patch.    This is to ensure that the model_patch does not disturb the repo&#39;s    tests when doing acceptance testing with the `test_patch`.    &#34;&#34;&#34;</span>    <span class=n>lines</span> <span class=o>=</span> <span class=n>model_patch</span><span class=o>.</span><span class=n>splitlines</span><span class=p>(</span><span class=n>keepends</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>    <span class=n>filtered_lines</span><span class=p>:</span> <span class=nb>list</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=p>[]</span>  
</span></span><span class=line><span class=cl>    <span class=n>test_patterns</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;/test/&#34;</span><span class=p>,</span> <span class=s2>&#34;/tests/&#34;</span><span class=p>,</span> <span class=s2>&#34;/testing/&#34;</span><span class=p>,</span> <span class=s2>&#34;test_&#34;</span><span class=p>,</span> <span class=s2>&#34;tox.ini&#34;</span><span class=p>]</span>  
</span></span><span class=line><span class=cl>    <span class=n>is_tests</span> <span class=o>=</span> <span class=kc>False</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>line</span> <span class=ow>in</span> <span class=n>lines</span><span class=p>:</span>  
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>line</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s2>&#34;diff --git a/&#34;</span><span class=p>):</span>  
</span></span><span class=line><span class=cl>            <span class=n>target_path</span> <span class=o>=</span> <span class=n>line</span><span class=o>.</span><span class=n>split</span><span class=p>()[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>  
</span></span><span class=line><span class=cl>            <span class=n>is_tests</span> <span class=o>=</span> <span class=n>target_path</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s2>&#34;b/&#34;</span><span class=p>)</span> <span class=ow>and</span> <span class=nb>any</span><span class=p>(</span>  
</span></span><span class=line><span class=cl>                <span class=n>p</span> <span class=ow>in</span> <span class=n>target_path</span> <span class=k>for</span> <span class=n>p</span> <span class=ow>in</span> <span class=n>test_patterns</span>  
</span></span><span class=line><span class=cl>            <span class=p>)</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>is_tests</span><span class=p>:</span>  
</span></span><span class=line><span class=cl>            <span class=n>filtered_lines</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>line</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s2>&#34;&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>filtered_lines</span><span class=p>)</span>
</span></span></code></pre></div><p>当执行步骤（轮次）超过 max_steps 限制时，会抛出 <code>Task execution exceeded maximum steps without completion.</code> 错误中止任务。</p><h3 id=状态转换>状态转换</h3><p>Agent 状态枚举</p><ul><li>THINKING： 初始状态，同时标识 LLM 调用中状态</li><li>CALLING_TOOL： 代表执行工具中</li><li>REFLECTING：反思状态，当工具执行异常时进入该状态</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>AgentState</span><span class=p>(</span><span class=n>Enum</span><span class=p>):</span>  
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Defines possible states during an agent&#39;s execution lifecycle.&#34;&#34;&#34;</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=n>IDLE</span> <span class=o>=</span> <span class=s2>&#34;idle&#34;</span>  
</span></span><span class=line><span class=cl>    <span class=n>RUNNING</span> <span class=o>=</span> <span class=s2>&#34;running&#34;</span>  
</span></span><span class=line><span class=cl>    <span class=n>COMPLETED</span> <span class=o>=</span> <span class=s2>&#34;completed&#34;</span>  
</span></span><span class=line><span class=cl>    <span class=n>ERROR</span> <span class=o>=</span> <span class=s2>&#34;error&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>AgentStepState</span><span class=p>(</span><span class=n>Enum</span><span class=p>):</span>  
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Defines possible states during an agent&#39;s execution lifecycle.&#34;&#34;&#34;</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    <span class=n>THINKING</span> <span class=o>=</span> <span class=s2>&#34;thinking&#34;</span>  
</span></span><span class=line><span class=cl>    <span class=n>CALLING_TOOL</span> <span class=o>=</span> <span class=s2>&#34;calling_tool&#34;</span>  
</span></span><span class=line><span class=cl>    <span class=n>REFLECTING</span> <span class=o>=</span> <span class=s2>&#34;reflecting&#34;</span>  
</span></span><span class=line><span class=cl>    <span class=n>COMPLETED</span> <span class=o>=</span> <span class=s2>&#34;completed&#34;</span>  
</span></span><span class=line><span class=cl>    <span class=n>ERROR</span> <span class=o>=</span> <span class=s2>&#34;error&#34;</span>  
</span></span></code></pre></div><p>AgentState 标识单次任务生命周期内的状态， AgentStepState 标识每轮执行步骤内的状态。一个 AgentState 内会有多个（轮）AgentStepState。每一轮步骤执行完成之后，都会创建一个新的 AgentStepState ，AgentStepState 的状态不会回退或者说状态机没有环。这种状态拆分的设计非常符合Agent 需要在循环内执行的情况。</p><p>AgentState 状态扭转</p><div class=mermaid align=center>stateDiagram-v2
[*] --> IDLE
IDLE --> RUNNING: 开始执行任务
RUNNING --> COMPLETED: 任务成功完成
RUNNING --> ERROR: 执行发生错误
COMPLETED --> [*]
ERROR --> [*]
note right of RUNNING: 在此状态下执行多个步骤</div><p>AgentStepState 状态扭转<div class=mermaid align=center>stateDiagram-v2
[*] --> THINKING
THINKING --> CALLING_TOOL: LLM决定调用工具
THINKING --> COMPLETED: LLM决定任务完成
CALLING_TOOL --> REFLECTING: 工具执行有问题需要反思
CALLING_TOOL --> COMPLETED: 工具执行成功
REFLECTING --> COMPLETED: 反思完成
THINKING --> ERROR: 推理过程出错
CALLING_TOOL --> ERROR: 工具调用出错
REFLECTING --> ERROR: 反思过程出错
COMPLETED --> [*]
ERROR --> [*]</div></p><h2 id=工具>工具</h2><h3 id=ckg-代码知识图谱>CKG 代码知识图谱</h3><p>代码知识图谱工具，用于构建和查询代码库的结构化信息。它提供三个核心功能：</p><ul><li>search_function: 搜索函数定义</li><li>search_class: 搜索类定义</li><li>search_class_method: 搜索类方法
用于解决下面这几类问题</li><li>代码理解: 快速定位函数和类的定义</li><li>代码导航: 找到具体的实现位置和行号</li><li>上下文分析: 了解函数/类的完整代码和结构信息</li></ul><p>Agent 会为每一个代码仓库快照构建一个database， 储存于本地的 sqlite，表结构如下</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- 函数表
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>functions</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=n>id</span><span class=w> </span><span class=nb>INTEGER</span><span class=w> </span><span class=k>PRIMARY</span><span class=w> </span><span class=k>KEY</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=n>NAME</span><span class=w> </span><span class=nb>TEXT</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w> </span><span class=c1>-- 函数名
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>	</span><span class=n>file_path</span><span class=w> </span><span class=nb>TEXT</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w> </span><span class=c1>-- 文件路径
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>	</span><span class=n>body</span><span class=w> </span><span class=nb>TEXT</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w> </span><span class=c1>-- 函数体代码
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>	</span><span class=n>start_line</span><span class=w> </span><span class=nb>INTEGER</span><span class=p>,</span><span class=w> </span><span class=c1>-- 起始行号
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>	</span><span class=n>end_line</span><span class=w> </span><span class=nb>INTEGER</span><span class=p>,</span><span class=w> </span><span class=c1>-- 结束行号
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>	</span><span class=n>parent_function</span><span class=w> </span><span class=nb>TEXT</span><span class=p>,</span><span class=w> </span><span class=c1>-- 父函数（嵌套函数）
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>	</span><span class=n>parent_class</span><span class=w> </span><span class=nb>TEXT</span><span class=w> </span><span class=c1>-- 所属类（方法）
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- 类表
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>classes</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=n>id</span><span class=w> </span><span class=nb>INTEGER</span><span class=w> </span><span class=k>PRIMARY</span><span class=w> </span><span class=k>KEY</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=n>NAME</span><span class=w> </span><span class=nb>TEXT</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w> </span><span class=c1>-- 类名
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>	</span><span class=n>file_path</span><span class=w> </span><span class=nb>TEXT</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w> </span><span class=c1>-- 文件路径
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>	</span><span class=n>body</span><span class=w> </span><span class=nb>TEXT</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w> </span><span class=c1>-- 类体代码
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>	</span><span class=n>fields</span><span class=w> </span><span class=nb>TEXT</span><span class=p>,</span><span class=w> </span><span class=c1>-- 字段列表
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>	</span><span class=n>methods</span><span class=w> </span><span class=nb>TEXT</span><span class=p>,</span><span class=w> </span><span class=c1>-- 方法列表
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>	</span><span class=n>start_line</span><span class=w> </span><span class=nb>INTEGER</span><span class=p>,</span><span class=w> </span><span class=c1>-- 起始行号
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>	</span><span class=n>end_line</span><span class=w> </span><span class=nb>INTEGER</span><span class=w> </span><span class=c1>-- 结束行号
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><h4 id=构建逻辑>构建逻辑</h4><p>CKG 会在 Agent 初始化时执行预清理清除旧的数据库，在工具被首次执行的时候懒加载，构建流程如下图。
构建时会以代码库的快照哈希判断是否需要重建。
代码库的快照哈希</p><ul><li>Git 仓库：基于 commit + 未提交变更</li><li>非 Git：基于文件元数据（文件名+修改时间+文件大小）</li></ul><div class=mermaid align=center>sequenceDiagram
participant Client as 客户端
participant CKG as CKGDatabase
participant FS as 文件系统
participant Git as Git命令
participant DB as SQLite数据库
Note over Client,DB: CKG 数据库初始化流程
Client->>CKG: __init__(codebase_path)
Note over CKG: 1. 初始化阶段
CKG->>CKG: 设置 _codebase_path
CKG->>FS: 检查 CKG_DATABASE_PATH 目录
alt 目录不存在
CKG->>FS: mkdir(parents=True, exist_ok=True)
end
Note over CKG: 2. 读取存储信息
CKG->>FS: 检查 CKG_STORAGE_INFO_FILE 是否存在
alt 存储信息文件存在
CKG->>FS: 读取 storage_info.json
FS-->>CKG: 返回 ckg_storage_info 字典
alt 当前路径在存储信息中
CKG->>CKG: existing_hash = ckg_storage_info[path]
else 路径不存在
CKG->>CKG: existing_hash = ""
end
else 存储信息文件不存在
CKG->>CKG: existing_hash = ""
end
Note over CKG: 3. 计算当前快照哈希
CKG->>Git: get_folder_snapshot_hash(codebase_path)
alt 是 Git 仓库
Git->>Git: 获取 commit hash + 未提交变更
Git-->>CKG: current_hash (git-clean-xxx 或 git-dirty-xxx)
else 非 Git 仓库
Git->>FS: 计算文件元数据哈希
FS-->>CKG: current_hash (metadata-xxx)
end
Note over CKG: 4. 比较哈希值并决策
alt existing_hash == current_hash
Note over CKG: 可以复用现有数据库
CKG->>CKG: database_path = get_ckg_database_path(existing_hash)
else 哈希值不同或为空
Note over CKG: 需要重建数据库
CKG->>CKG: old_db_path = get_ckg_database_path(existing_hash)
alt 旧数据库存在
CKG->>FS: 删除旧数据库文件
end
CKG->>CKG: database_path = get_ckg_database_path(current_hash)
CKG->>CKG: 更新 ckg_storage_info[path] = current_hash
CKG->>FS: 保存更新后的 storage_info.json
end
Note over CKG: 5. 连接/创建数据库
alt 数据库文件存在
Note over CKG: 复用现有数据库
CKG->>DB: sqlite3.connect(database_path)
DB-->>CKG: 数据库连接
else 数据库文件不存在
Note over CKG: 创建新数据库
CKG->>DB: sqlite3.connect(database_path)
DB-->>CKG: 数据库连接
loop 创建表结构
CKG->>DB: execute(CREATE TABLE functions...)
CKG->>DB: execute(CREATE TABLE classes...)
end
CKG->>DB: commit()
Note over CKG: 构建代码知识图谱
CKG->>CKG: _construct_ckg()
Note over CKG,FS: 遍历代码文件，解析AST，插入数据库
loop 处理每个代码文件
CKG->>FS: 读取源文件
CKG->>CKG: tree-sitter 解析 AST
CKG->>DB: 插入函数/类信息
end
end
CKG-->>Client: 初始化完成，返回 CKGDatabase 实例</div><p>目前支持部分语言构建代码知识图谱：</p><ul><li>python</li><li>Java</li><li>Cpp</li><li>C</li><li>Typescript</li><li>Javascript</li></ul><h3 id=bash>Bash</h3><p>Trae Agent 提供了 bash 工具，支持在 Unix 和 Windows 下工作。通过 bash shell 工具，可以支持执行各种复杂命令以及持久化会话状态。</p><div class=mermaid align=center>sequenceDiagram
participant A as Agent
participant BT as BashTool
participant BS as BashSession
participant P as Process
A->>BT: execute(command)
BT->>BT: 检查session
alt session不存在
BT->>BS: 创建新session
BS->>P: 启动bash进程
P-->>BS: 进程创建成功
end
BT->>BS: run(command)
BS->>BS: 构造sentinel
BS->>P: 发送包装后的命令
loop 轮询输出
BS->>P: 读取stdout缓冲区
P-->>BS: 返回当前输出
alt 找到sentinel
BS->>BS: 解析输出和错误码
else 超时
BS->>BS: 设置超时状态
end
end
BS->>P: 读取stderr
P-->>BS: 返回错误信息
BS-->>BT: 返回结果
BT-->>A: 返回ToolExecResult</div><p>Sentinel机制</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>_sentinel</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&#34;,,,,bash-command-exit-__ERROR_CODE__-banner,,,,&#34;</span> <span class=c1># `__ERROR_CODE__` will be replaced by `$?` or `!errorlevel!` later</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>sentinel_before</span><span class=p>,</span> <span class=n>pivot</span><span class=p>,</span> <span class=n>sentinel_after</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_sentinel</span><span class=o>.</span><span class=n>partition</span><span class=p>(</span><span class=s2>&#34;__ERROR_CODE__&#34;</span><span class=p>)</span>  
</span></span><span class=line><span class=cl><span class=k>assert</span> <span class=n>pivot</span> <span class=o>==</span> <span class=s2>&#34;__ERROR_CODE__&#34;</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl><span class=n>errcode_retriever</span> <span class=o>=</span> <span class=s2>&#34;!errorlevel!&#34;</span> <span class=k>if</span> <span class=n>os</span><span class=o>.</span><span class=n>name</span> <span class=o>==</span> <span class=s2>&#34;nt&#34;</span> <span class=k>else</span> <span class=s2>&#34;$?&#34;</span>  
</span></span><span class=line><span class=cl><span class=n>command_sep</span> <span class=o>=</span> <span class=s2>&#34;&amp;&#34;</span> <span class=k>if</span> <span class=n>os</span><span class=o>.</span><span class=n>name</span> <span class=o>==</span> <span class=s2>&#34;nt&#34;</span> <span class=k>else</span> <span class=s2>&#34;;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># send command to the process  </span>
</span></span><span class=line><span class=cl><span class=bp>self</span><span class=o>.</span><span class=n>_process</span><span class=o>.</span><span class=n>stdin</span><span class=o>.</span><span class=n>write</span><span class=p>(</span>  
</span></span><span class=line><span class=cl>    <span class=sa>b</span><span class=s2>&#34;(</span><span class=se>\n</span><span class=s2>&#34;</span>  
</span></span><span class=line><span class=cl>    <span class=o>+</span> <span class=n>command</span><span class=o>.</span><span class=n>encode</span><span class=p>()</span>  
</span></span><span class=line><span class=cl>    <span class=o>+</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>)</span><span class=si>{</span><span class=n>command_sep</span><span class=si>}</span><span class=s2> echo </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>_sentinel</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s1>&#39;__ERROR_CODE__&#39;</span><span class=p>,</span> <span class=n>errcode_retriever</span><span class=p>)</span><span class=si>}</span><span class=se>\n</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>encode</span><span class=p>()</span>  
</span></span><span class=line><span class=cl><span class=p>)</span>  
</span></span><span class=line><span class=cl><span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_process</span><span class=o>.</span><span class=n>stdin</span><span class=o>.</span><span class=n>drain</span><span class=p>()</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl><span class=c1># read output from the process, until the sentinel is found  </span>
</span></span><span class=line><span class=cl><span class=k>try</span><span class=p>:</span>  
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>with</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>timeout</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_timeout</span><span class=p>):</span>  
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>  
</span></span><span class=line><span class=cl>            <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_output_delay</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>            <span class=c1># if we read directly from stdout/stderr, it will wait forever for  </span>
</span></span><span class=line><span class=cl>            <span class=c1># EOF. use the StreamReader buffer directly instead.            output: str = self._process.stdout._buffer.decode()  # type: ignore[attr-defined] # pyright: ignore[reportAttributeAccessIssue, reportUnknownMemberType, reportUnknownVariableType]  </span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>sentinel_before</span> <span class=ow>in</span> <span class=n>output</span><span class=p>:</span>  
</span></span><span class=line><span class=cl>                <span class=c1># strip the sentinel from output  </span>
</span></span><span class=line><span class=cl>                <span class=n>output</span><span class=p>,</span> <span class=n>pivot</span><span class=p>,</span> <span class=n>exit_banner</span> <span class=o>=</span> <span class=n>output</span><span class=o>.</span><span class=n>rpartition</span><span class=p>(</span><span class=n>sentinel_before</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>                <span class=k>assert</span> <span class=n>pivot</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>                <span class=c1># get error code inside banner  </span>
</span></span><span class=line><span class=cl>                <span class=n>error_code_str</span><span class=p>,</span> <span class=n>pivot</span><span class=p>,</span> <span class=n>_</span> <span class=o>=</span> <span class=n>exit_banner</span><span class=o>.</span><span class=n>partition</span><span class=p>(</span><span class=n>sentinel_after</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=ow>not</span> <span class=n>pivot</span> <span class=ow>or</span> <span class=ow>not</span> <span class=n>error_code_str</span><span class=o>.</span><span class=n>isdecimal</span><span class=p>():</span>  
</span></span><span class=line><span class=cl>                    <span class=k>continue</span>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>                <span class=n>error_code</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>error_code_str</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>                <span class=k>break</span>  
</span></span><span class=line><span class=cl><span class=k>except</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>TimeoutError</span><span class=p>:</span>  
</span></span><span class=line><span class=cl>    <span class=bp>self</span><span class=o>.</span><span class=n>_timed_out</span> <span class=o>=</span> <span class=kc>True</span>  
</span></span><span class=line><span class=cl>    <span class=k>raise</span> <span class=n>ToolError</span><span class=p>(</span>  
</span></span><span class=line><span class=cl>        <span class=sa>f</span><span class=s2>&#34;timed out: bash has not returned in </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>_timeout</span><span class=si>}</span><span class=s2> seconds and must be restarted&#34;</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=kn>from</span> <span class=bp>None</span>
</span></span></code></pre></div><p>通过在执行命令后面附加 <code>echo sentinel</code> ，可以通过sentinel 标识区分获取任务的结束输出以及错误码。</p></div><div class="flex items-center justify-center" style=min-height:120px><p>-- End --</p></div><div class=mt-16></div></article></div></main><footer class="fixed left-0 bottom-0 w-full bg-base px-page-gutter"><div class="flex justify-center items-center h-footer-height"><div class="flex flex-row w-full max-w-content justify-between lowercase italic gap-3"><nav><a href=https://example.org//index.xml><svg width="18" height="18" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12.75 19.5v-.75a7.5 7.5.0 00-7.5-7.5H4.5m0-6.75h.75c7.87.0 14.25 6.38 14.25 14.25v.75M6 18.75a.75.75.0 11-1.5.0.75.75.0 011.5.0z"/></svg></a></nav><span class="text-muted hidden md:block">&copy;
2025 Mingheng Lu
Powered by
<a href=https://github.com/ntk148v/hugo-toigian class="font-bold hover:underline">hugo-toigian</a></span><div id=header-theme-button><svg id="dark_mode_btn" class="hidden toolbox-btn" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718.0 0118 15.75c-5.385.0-9.75-4.365-9.75-9.75.0-1.33.266-2.597.748-3.752A9.753 9.753.0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753.0 009.002-5.998z"/></svg>
<svg id="light_mode_btn" class="hidden toolbox-btn" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386-1.591 1.591M21 12h-2.25m-.386 6.364-1.591-1.591M12 18.75V21m-4.773-4.227-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75.0 11-7.5.0 3.75 3.75.0 017.5.0z"/></svg></div></div></div></footer></body></html>