<!DOCTYPE html>
<html lang="en"><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta charset="utf-8" />
  <meta
    name="description"
    content="Author: Lyeka <augustr2017@163.com>"
  />
  <title>
    
      Lyeka
      | Trae Agent 源码阅读
    
  </title>
  <meta name="author" content="map[email:augustr2017@163.com name:Lyeka]" />
  <meta name="description" content="" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <link
    rel="icon"
    href="/favicon_io/favicon.ico"
    type="image/x-icon"
  />
  <link
    rel="icon"
    href="/favicon_io/favicon-16x16.png"
    size="16x16"
    type="image/png"
  />
  <link
    rel="icon"
    href="/favicon_io/favicon-32x32.png"
    size="32x32"
    type="image/png"
  />

  <link
    rel="preload"
    type="text/css"
    href="/css/rose-pine.min.css"
    integrity=""
    as="style"
    onload="this.onload=null;this.rel='stylesheet'"
  />
  <noscript>
    <link
      rel="stylesheet"
      type="text/css"
      href="/css/rose-pine.min.css"
      integrity=""
    />
  </noscript>
<link
    rel="preload"
    type="text/css"
    href="/css/toigian.css"
    integrity=""
    as="style"
    onload="this.onload=null;this.rel='stylesheet'"
  />
  <noscript>
    <link
      rel="stylesheet"
      type="text/css"
      href="/css/toigian.css"
      integrity=""
    />
  </noscript>

  
  <link
    rel="stylesheet"
    type="text/css"
    href="/css/light.css"
    integrity=""
  />
  <link
    rel="stylesheet"
    type="text/css"
    href="/css/dark.css"
    integrity=""
  />

  <script>
    
    if (
      localStorage.theme === "dark" ||
      (!("theme" in localStorage) &&
        window.matchMedia("(prefers-color-scheme: dark)").matches)
    ) {
      document.documentElement.classList.add("dark");
    } else {
      document.documentElement.classList.remove("dark");
    }
  </script>

  
  


  
  <script
    async
    defer
    src="/js/main.js"
    integrity=""
  ></script>
  <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
  <script>
    mermaid.initialize({ startOnLoad: true, securityLevel: "loose" });
  </script>
  
  
<style>
    :root { --content-width: 48rem; }            
    @media (min-width: 1280px) { :root { --content-width: 48rem; } }   
     
     
  </style>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;700&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&family=Noto+Serif+SC:wght@200..900&family=ZCOOL+XiaoWei&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=LXGW+WenKai+Mono+TC&family=Montserrat:ital,wght@0,100..900;1,100..900&family=Noto+Serif+SC:wght@200..900&family=ZCOOL+XiaoWei&display=swap" rel="stylesheet">
  <style>
  :root {
       
      --font-sans: "LXGW WenKai Mono TC", "ZCOOL XiaoWei", "Songti SC", "SimSun", "NSimSun", "Noto Serif SC", serif;
       
      --font-mono: "Berkeley Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  }
  </style>


</head>
<body><header style="--layer: 10">
  <div
    aria-hidden="true"
    class="absolute top-[-1000px] left-0 z-[calc(var(--layer)+1)] h-[calc(1000px+var(--page-top))] w-full bg-base"
  ></div>

  <div
    class="fixed top-0 left-0 z-[var(--layer)] flex h-header-height w-full items-center border-b px-page-gutter before:absolute before:inset-0 before:z-[-1] before:bg-base [@supports(backdrop-filter:blur(0))]:before:bg-base [@supports(backdrop-filter:blur(0))]:before:backdrop-blur-md"
  ><div
  class="lowercase italic mx-auto flex w-full max-w-content items-center justify-between"
>
  <nav class="mr-3">
    <ol class="flex text-md items-center">
      
  
    
  
    
  
  
  
  <li>
    
    
    <a href="/" class="text-muted focus:underline focus:outline-none pr-1 whitespace-nowrap">Lyeka</a>
  </li>
  
    <li class="text-muted focus:underline focus:outline-none pr-1 whitespace-nowrap">/</li>
  

  
  
  
  <li>
    
    
    <a href="/posts/" class="text-muted focus:underline focus:outline-none pr-1 whitespace-nowrap">Posts</a>
  </li>
  
    <li class="text-muted focus:underline focus:outline-none pr-1 whitespace-nowrap">/</li>
  

  
  
  
    
  
  <li>
    
    
    <a href="/posts/trae_agent_read/" class="focus:underline focus:outline-none font-bold pr-1 hidden md:block">Trae Agent 源码阅读</a>
  </li>
  

    </ol>
  </nav>
  <nav class="ml-3">
    <ul class="flex text-md whitespace-nowrap">
      
        <li class="pl-2">
          <a href="/reading" class="tracking-wide hover:underline"
            >/Read</a
          >
        </li>
      
        <li class="pl-2">
          <a href="/posts" class="tracking-wide hover:underline"
            >/Posts</a
          >
        </li>
      
        <li class="pl-2">
          <a href="/about" class="tracking-wide hover:underline"
            >/About</a
          >
        </li>
      
    </ul>
  </nav>
</div>


</div>
</header>
<main class="flex justify-center px-page-gutter py-page-top">
      <div class="min-h-content w-full max-w-content space-y-10 sm:space-y-20"><div
  class="lowercase italic mx-auto flex w-full max-w-content items-center justify-between"
>
  <nav class="mr-3">
    <ol class="flex text-md items-center">
      
  
    
  
    
  
  
  
  <li>
    
    
    <a href="/" class="text-muted focus:underline focus:outline-none pr-1 whitespace-nowrap">Lyeka</a>
  </li>
  
    <li class="text-muted focus:underline focus:outline-none pr-1 whitespace-nowrap">/</li>
  

  
  
  
  <li>
    
    
    <a href="/posts/" class="text-muted focus:underline focus:outline-none pr-1 whitespace-nowrap">Posts</a>
  </li>
  
    <li class="text-muted focus:underline focus:outline-none pr-1 whitespace-nowrap">/</li>
  

  
  
  
    
  
  <li>
    
    
    <a href="/posts/trae_agent_read/" class="focus:underline focus:outline-none font-bold pr-1 hidden md:block">Trae Agent 源码阅读</a>
  </li>
  

    </ol>
  </nav>
  <nav class="ml-3">
    <ul class="flex text-md whitespace-nowrap">
      
        <li class="pl-2">
          <a href="/reading" class="tracking-wide hover:underline"
            >/Read</a
          >
        </li>
      
        <li class="pl-2">
          <a href="/posts" class="tracking-wide hover:underline"
            >/Posts</a
          >
        </li>
      
        <li class="pl-2">
          <a href="/about" class="tracking-wide hover:underline"
            >/About</a
          >
        </li>
      
    </ul>
  </nav>
</div>


<article>
  <h1>Trae Agent 源码阅读</h1>
  
  <time
    datetime="2025/09/26"
    class="mr-1 text-sm italic tabular-nums text-muted"
  >
    2025/09/26&nbsp;
  </time>

  

  


<div id="toc">
  
    
      <details open>
        <summary>Table of contents</summary>
        <div id="toc-list"><nav id="TableOfContents">
  <ol>
    <li><a href="#项目概览">项目概览</a>
      <ol>
        <li><a href="#目录结构">目录结构</a></li>
        <li><a href="#关系图谱">关系图谱</a></li>
      </ol>
    </li>
    <li><a href="#核心流程">核心流程</a>
      <ol>
        <li><a href="#状态转换">状态转换</a></li>
      </ol>
    </li>
    <li><a href="#工具">工具</a>
      <ol>
        <li><a href="#ckg-tool">CKG Tool</a>
          <ol>
            <li><a href="#ckg-schema">CKG Schema</a></li>
            <li><a href="#构建逻辑">构建逻辑</a></li>
          </ol>
        </li>
        <li><a href="#bash--tool">Bash  Tool</a>
          <ol>
            <li><a href="#sentinel机制">Sentinel机制</a></li>
          </ol>
        </li>
        <li><a href="#edit-tool">Edit Tool</a>
          <ol>
            <li><a href="#文件路径校验">文件路径校验</a></li>
            <li><a href="#结果输出">结果输出</a></li>
          </ol>
        </li>
        <li><a href="#sequential-thinking-tool">Sequential Thinking Tool</a>
          <ol>
            <li><a href="#prompt">Prompt</a></li>
            <li><a href="#结构化思考">结构化思考</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#评估">评估</a>
      <ol>
        <li><a href="#swe-bench">SWE Bench</a></li>
        <li><a href="#patch-selection">Patch Selection</a>
          <ol>
            <li><a href="#prompt-1">Prompt</a></li>
            <li><a href="#核心流程-1">核心流程</a></li>
          </ol>
        </li>
      </ol>
    </li>
  </ol>
</nav></div>
      </details>
    
  
</div>
<div class="content"><h2 id="项目概览">项目概览</h2>
 

  

<blockquote class="my-5 p-4 rounded border-solid border-2 border-foam">
  项目地址：<a href="https://github.com/bytedance/trae-agent">trae-agent</a>
本文分析基于 Git commit 2cb657823bc5f9bdf276a69d2bcdd60ec389de46 版本
</blockquote>

<p>Trae agent 是字节开源的 LLM Agent，用于解决通用软件领域问题。项目包含了 UI (CLI) 和 Agent 部分，本文着重研究核心的  Agent 部分。</p>
<h3 id="目录结构">目录结构</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">trae-agent/
</span></span><span class="line"><span class="cl">├── trae_agent/                       <span class="c1"># 核心包目录</span>
</span></span><span class="line"><span class="cl">│   ├── agent/                        <span class="c1"># Agent核心逻辑</span>
</span></span><span class="line"><span class="cl">│   │   ├── agent_basics.py           <span class="c1"># 基础数据结构 (AgentState, AgentStep)</span>
</span></span><span class="line"><span class="cl">│   │   ├── base_agent.py             <span class="c1"># 抽象基类 (ReAct循环逻辑)</span>
</span></span><span class="line"><span class="cl">│   │   ├── trae_agent.py             <span class="c1"># 具体实现 (软件工程专用)</span>
</span></span><span class="line"><span class="cl">│   │   ├── agent.py                  <span class="c1"># 包装器 (外观模式)</span>
</span></span><span class="line"><span class="cl">│   │   └── docker_manager.py         <span class="c1"># Docker环境管理</span>
</span></span><span class="line"><span class="cl">│   │
</span></span><span class="line"><span class="cl">│   ├── tools/                        <span class="c1"># 工具集合</span>
</span></span><span class="line"><span class="cl">│   │   ├── base.py                   <span class="c1"># 工具基类和接口</span>
</span></span><span class="line"><span class="cl">│   │   ├── bash_tool.py              <span class="c1"># Shell命令执行</span>
</span></span><span class="line"><span class="cl">│   │   ├── edit_tool.py              <span class="c1"># 文件编辑工具</span>
</span></span><span class="line"><span class="cl">│   │   ├── json_edit_tool.py         <span class="c1"># JSON编辑工具</span>
</span></span><span class="line"><span class="cl">│   │   ├── task_done_tool.py         <span class="c1"># 任务完成工具</span>
</span></span><span class="line"><span class="cl">│   │   ├── sequential_thinking_tool.py <span class="c1"># 结构化思考</span>
</span></span><span class="line"><span class="cl">│   │   ├── mcp_tool.py               <span class="c1"># MCP协议工具</span>
</span></span><span class="line"><span class="cl">│   │   └── ckg/                      <span class="c1"># 代码知识图谱</span>
</span></span><span class="line"><span class="cl">│   │
</span></span><span class="line"><span class="cl">│   ├── utils/                        <span class="c1"># 工具类模块</span>
</span></span><span class="line"><span class="cl">│   │   ├── llm_clients/              <span class="c1"># LLM客户端</span>
</span></span><span class="line"><span class="cl">│   │   │   ├── llm_client.py         <span class="c1"># 统一客户端接口</span>
</span></span><span class="line"><span class="cl">│   │   │   ├── anthropic_client.py   <span class="c1"># Claude集成</span>
</span></span><span class="line"><span class="cl">│   │   │   ├── openai_client.py      <span class="c1"># GPT集成</span>
</span></span><span class="line"><span class="cl">│   │   │   ├── google_client.py      <span class="c1"># Gemini集成</span>
</span></span><span class="line"><span class="cl">│   │   │   └── ...                   <span class="c1"># 其他LLM提供商</span>
</span></span><span class="line"><span class="cl">│   │   │
</span></span><span class="line"><span class="cl">│   │   ├── cli/                      <span class="c1"># 命令行界面</span>
</span></span><span class="line"><span class="cl">│   │   │   ├── console_factory.py    <span class="c1"># 控制台工厂</span>
</span></span><span class="line"><span class="cl">│   │   │   ├── simple_console.py     <span class="c1"># 简单文本界面</span>
</span></span><span class="line"><span class="cl">│   │   │   └── rich_console.py       <span class="c1"># 富文本界面</span>
</span></span><span class="line"><span class="cl">│   │   │
</span></span><span class="line"><span class="cl">│   │   ├── config.py                 <span class="c1"># 配置管理</span>
</span></span><span class="line"><span class="cl">│   │   ├── trajectory_recorder.py    <span class="c1"># 轨迹记录</span>
</span></span><span class="line"><span class="cl">│   │   └── mcp_client.py             <span class="c1"># MCP协议客户端</span>
</span></span><span class="line"><span class="cl">│   │
</span></span><span class="line"><span class="cl">│   ├── prompt/                       <span class="c1"># 提示词管理</span>
</span></span><span class="line"><span class="cl">│   │   └── agent_prompt.py           <span class="c1"># Agent提示词</span>
</span></span><span class="line"><span class="cl">│   │
</span></span><span class="line"><span class="cl">│   ├── cli.py                        <span class="c1"># 命令行入口</span>
</span></span><span class="line"><span class="cl">│   └── dist/                         <span class="c1"># 分发工具</span>
</span></span><span class="line"><span class="cl">│
</span></span><span class="line"><span class="cl">├── evaluation/                       <span class="c1"># 评估框架</span>
</span></span><span class="line"><span class="cl">│   ├── run_evaluation.py             <span class="c1"># SWE-bench评估脚本</span>
</span></span><span class="line"><span class="cl">│   ├── utils.py                      <span class="c1"># 评估工具函数</span>
</span></span><span class="line"><span class="cl">│   └── patch_selection/              <span class="c1"># 补丁选择评估</span>
</span></span><span class="line"><span class="cl">│
</span></span><span class="line"><span class="cl">├── tests/                            <span class="c1"># 测试套件</span>
</span></span><span class="line"><span class="cl">│   ├── agent/                        <span class="c1"># Agent测试</span>
</span></span><span class="line"><span class="cl">│   ├── tools/                        <span class="c1"># 工具测试</span>
</span></span><span class="line"><span class="cl">│   └── utils/                        <span class="c1"># 工具类测试</span>
</span></span><span class="line"><span class="cl">│
</span></span><span class="line"><span class="cl">├── docs/                             <span class="c1"># 文档</span>
</span></span><span class="line"><span class="cl">│   ├── tools.md                      <span class="c1"># 工具文档</span>
</span></span><span class="line"><span class="cl">│   └── TRAJECTORY_RECORDING.md       <span class="c1"># 轨迹记录文档</span>
</span></span><span class="line"><span class="cl">│
</span></span><span class="line"><span class="cl">├── server/                           <span class="c1"># FastAPI服务端 (可选)</span>
</span></span><span class="line"><span class="cl">│
</span></span><span class="line"><span class="cl">├── pyproject.toml                    <span class="c1"># Python项目配置</span>
</span></span><span class="line"><span class="cl">├── trae_config.yaml.example          <span class="c1"># 配置模板</span>
</span></span><span class="line"><span class="cl">└── README.md                         <span class="c1"># 项目说明</span>
</span></span></code></pre></div><h3 id="关系图谱">关系图谱</h3>
<pre class="mermaid">
    graph TB
    %% 外部接口层
    CLI[CLI Interface&lt;br/&gt;trae_agent/cli.py] --&gt; Agent[Agent&lt;br/&gt;trae_agent/agent/agent.py]
    Server[FastAPI Server&lt;br/&gt;server/] --&gt; Agent
    
    %% 代理层
    Agent --&gt; TraeAgent[TraeAgent&lt;br/&gt;trae_agent/agent/trae_agent.py]
    Agent --&gt; BaseAgent[BaseAgent&lt;br/&gt;trae_agent/agent/base_agent.py]
    TraeAgent -.-&gt; BaseAgent
    
    %% 配置层
    Config[Configuration&lt;br/&gt;trae_agent/utils/config.py] --&gt; Agent
    Config --&gt; TraeAgent
    
    %% LLM 客户端层
    BaseAgent --&gt; LLMClient[LLM Client&lt;br/&gt;trae_agent/utils/llm_clients/]
    LLMClient --&gt; Anthropic[anthropic_client.py]
    LLMClient --&gt; OpenAI[openai_client.py]
    LLMClient --&gt; Google[google_client.py]
    LLMClient --&gt; Ollama[ollama_client.py]
    LLMClient --&gt; Azure[azure_client.py]
    LLMClient --&gt; Doubao[doubao_client.py]
    LLMClient --&gt; OpenRouter[openrouter_client.py]
    
    %% 工具执行层
    BaseAgent --&gt; ToolExecutor[Tool Executor&lt;br/&gt;trae_agent/tools/base.py]
    BaseAgent --&gt; DockerToolExecutor[Docker Tool Executor&lt;br/&gt;trae_agent/tools/docker_tool_executor.py]
    
    ToolExecutor --&gt; ToolRegistry[Tools Registry&lt;br/&gt;trae_agent/tools/__init__.py]
    DockerToolExecutor --&gt; ToolRegistry
    
    %% 工具实现层
    ToolRegistry --&gt; BashTool[Bash Tool]
    ToolRegistry --&gt; EditTool[Text Editor Tool]
    ToolRegistry --&gt; JSONEditTool[JSON Edit Tool]
    ToolRegistry --&gt; ThinkingTool[Sequential Thinking Tool]
    ToolRegistry --&gt; TaskDoneTool[Task Done Tool]
    ToolRegistry --&gt; CKGTool[Code Knowledge Graph Tool]
    
    %% MCP 工具层
    TraeAgent --&gt; MCPClient[MCP Client&lt;br/&gt;trae_agent/utils/mcp_client.py]
    MCPClient --&gt; MCPTool[MCP Tools&lt;br/&gt;trae_agent/tools/mcp_tool.py]
    
    %% Docker 管理层
    BaseAgent --&gt; DockerManager[Docker Manager&lt;br/&gt;trae_agent/agent/docker_manager.py]
    
    %% 控制台层
    Agent --&gt; CLIConsole[CLI Console&lt;br/&gt;trae_agent/utils/cli/]
    CLIConsole --&gt; SimpleConsole[Simple Console]
    CLIConsole --&gt; RichConsole[Rich Console]
    
    %% 轨迹记录层
    Agent --&gt; TrajectoryRecorder[Trajectory Recorder&lt;br/&gt;trae_agent/utils/trajectory_recorder.py]
    
    %% 提示层
    TraeAgent --&gt; SystemPrompt[System Prompt&lt;br/&gt;trae_agent/prompt/agent_prompt.py]
    
    %% 评估层
    Evaluation[Evaluation&lt;br/&gt;evaluation/] --&gt; Agent
    Evaluation --&gt; SWEBench[SWE-bench]
    Evaluation --&gt; SWEBenchLive[SWE-bench-Live]
    Evaluation --&gt; MultiSWEBench[Multi-SWE-bench]
    
    %% 测试层
    Tests[Tests&lt;br/&gt;tests/] -.-&gt; Agent
    Tests -.-&gt; ToolRegistry
    Tests -.-&gt; Config
    
    %% 样式定义
    classDef interface fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef core fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef tools fill:#e8f5e8,stroke:#1b5e20,stroke-width:2px
    classDef llm fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef utils fill:#f1f8e9,stroke:#33691e,stroke-width:2px
    classDef eval fill:#fce4ec,stroke:#880e4f,stroke-width:2px
    
    class CLI,Server interface
    class Agent,TraeAgent,BaseAgent core
    class ToolExecutor,DockerToolExecutor,ToolRegistry,BashTool,EditTool,JSONEditTool,ThinkingTool,TaskDoneTool,CKGTool,MCPTool tools
    class LLMClient,Anthropic,OpenAI,Google,Ollama,Azure,Doubao,OpenRouter llm
    class Config,CLIConsole,TrajectoryRecorder,DockerManager,MCPClient,SystemPrompt utils
    class Evaluation,SWEBench,SWEBenchLive,MultiSWEBench,Tests eval
  </pre>
  <h2 id="核心流程">核心流程</h2>
<pre class="mermaid">
    sequenceDiagram
    participant CLI
    participant Agent
    participant TraeAgent
    participant LLMClient
    participant ToolExecutor
    participant CLIConsole
    participant TrajectoryRecorder

    Note over CLI,TrajectoryRecorder: 1. 初始化阶段
    CLI-&gt;&gt;Agent: create(agent_type, config, console)
    Agent-&gt;&gt;TraeAgent: new TraeAgent(config)
    Agent-&gt;&gt;CLIConsole: set_cli_console()
    Agent-&gt;&gt;TrajectoryRecorder: set_trajectory_recorder()

    Note over CLI,TrajectoryRecorder: 2. 任务启动
    CLI-&gt;&gt;Agent: run(task, task_args)
    Agent-&gt;&gt;TraeAgent: new_task(task, extra_args)
    TraeAgent-&gt;&gt;TraeAgent: setup initial messages
    TraeAgent-&gt;&gt;TrajectoryRecorder: start_recording()

    alt MCP 工具需要初始化
        Agent-&gt;&gt;TraeAgent: initialise_mcp()
        TraeAgent-&gt;&gt;TraeAgent: discover_mcp_tools()
    end

    Agent-&gt;&gt;CLIConsole: print_task_details()
    
    par 并行启动
        Agent-&gt;&gt;CLIConsole: start() [异步任务]
    and
        Agent-&gt;&gt;TraeAgent: execute_task()
    end

    Note over CLI,TrajectoryRecorder: 3. 主执行循环
    loop 最多 max_steps 次
        TraeAgent-&gt;&gt;CLIConsole: update_status(THINKING)
        TraeAgent-&gt;&gt;LLMClient: chat(messages, tools)
        LLMClient--&gt;&gt;TraeAgent: llm_response
        TraeAgent-&gt;&gt;CLIConsole: update_status(response)

        alt LLM 说任务完成
            TraeAgent-&gt;&gt;TraeAgent: llm_indicates_task_completed()
            alt 真正完成
                TraeAgent-&gt;&gt;TraeAgent: _is_task_completed()
                TraeAgent-&gt;&gt;TraeAgent: set COMPLETED state
                Note over TraeAgent: 跳出循环
            else 实际未完成
                TraeAgent-&gt;&gt;TraeAgent: task_incomplete_message()
                Note over TraeAgent: 继续循环
            end
        else LLM 要执行工具
            TraeAgent-&gt;&gt;CLIConsole: update_status(CALLING_TOOL)
            alt 并行工具调用
                TraeAgent-&gt;&gt;ToolExecutor: parallel_tool_call()
            else 串行工具调用
                TraeAgent-&gt;&gt;ToolExecutor: sequential_tool_call()
            end
            ToolExecutor--&gt;&gt;TraeAgent: tool_results
            TraeAgent-&gt;&gt;CLIConsole: update_status(tool_results)
            
            opt 需要反思
                TraeAgent-&gt;&gt;TraeAgent: reflect_on_result()
                TraeAgent-&gt;&gt;CLIConsole: update_status(REFLECTING)
            end
        end

        TraeAgent-&gt;&gt;TrajectoryRecorder: record_agent_step()
        TraeAgent-&gt;&gt;CLIConsole: update_status(COMPLETED step)
    end

    Note over CLI,TrajectoryRecorder: 4. 清理阶段
    TraeAgent-&gt;&gt;ToolExecutor: close_tools()
    TraeAgent-&gt;&gt;TraeAgent: cleanup_mcp_clients()
    TraeAgent--&gt;&gt;Agent: execution_result
    Agent-&gt;&gt;CLIConsole: 等待控制台任务完成
    Agent--&gt;&gt;CLI: 返回执行结果
    CLI-&gt;&gt;CLI: 显示轨迹文件路径
  </pre>
  <p>Trae Agent 整体设计上采用了 ReAct 模式，当创建 Agent 实例并初始化资源后，开始在循环中执行任务，交替执行 LLM 推理、工具执行，失败反思步骤，直到任务完成。
任务的完成分为两步，一是解析 LLM 的 Response 中是否有任务结束标识（ 是否包含 <code>task_done</code> 等关键字），二是当必须有代码变更时，检查是否有除了 test 文件之外的的改动（目前看起来只有 SWE Bench 评估才有这个 <code>_is_task_completed</code> 流程）。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="nd">@override</span>  
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">_is_task_completed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">llm_response</span><span class="p">:</span> <span class="n">LLMResponse</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Enhanced task completion detection.&#34;&#34;&#34;</span>  
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">must_patch</span> <span class="o">==</span> <span class="s2">&#34;true&#34;</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">        <span class="n">model_patch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_git_diff</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">        <span class="n">patch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_patches_to_tests</span><span class="p">(</span><span class="n">model_patch</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">patch</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>  
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">False</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">remove_patches_to_tests</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_patch</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;  
</span></span></span><span class="line"><span class="cl"><span class="s2">    Remove any changes to the tests directory from the provided patch.    This is to ensure that the model_patch does not disturb the repo&#39;s    tests when doing acceptance testing with the `test_patch`.    &#34;&#34;&#34;</span>    <span class="n">lines</span> <span class="o">=</span> <span class="n">model_patch</span><span class="o">.</span><span class="n">splitlines</span><span class="p">(</span><span class="n">keepends</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="n">filtered_lines</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>  
</span></span><span class="line"><span class="cl">    <span class="n">test_patterns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;/test/&#34;</span><span class="p">,</span> <span class="s2">&#34;/tests/&#34;</span><span class="p">,</span> <span class="s2">&#34;/testing/&#34;</span><span class="p">,</span> <span class="s2">&#34;test_&#34;</span><span class="p">,</span> <span class="s2">&#34;tox.ini&#34;</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl">    <span class="n">is_tests</span> <span class="o">=</span> <span class="kc">False</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&#34;diff --git a/&#34;</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">            <span class="n">target_path</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  
</span></span><span class="line"><span class="cl">            <span class="n">is_tests</span> <span class="o">=</span> <span class="n">target_path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&#34;b/&#34;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span>  
</span></span><span class="line"><span class="cl">                <span class="n">p</span> <span class="ow">in</span> <span class="n">target_path</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">test_patterns</span>  
</span></span><span class="line"><span class="cl">            <span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_tests</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">            <span class="n">filtered_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="s2">&#34;&#34;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filtered_lines</span><span class="p">)</span>
</span></span></code></pre></div><p>当执行步骤（轮次）超过 max_steps 限制时，会抛出 <code>Task execution exceeded maximum steps without completion.</code> 错误中止任务。</p>
<h3 id="状态转换">状态转换</h3>
<p>Trae Agent 核心包括两个状态</p>
<ul>
<li>AgentState：单次任务生命周期内的状态</li>
<li>AgentStepState：每轮执行步骤内的状态</li>
</ul>
<p>一个 AgentState 内会有多个（轮）AgentStepState。每一轮步骤执行完成之后，都会创建一个新的 AgentStepState ，AgentStepState 的状态不会回退或者说状态机没有环。这种状态拆分的设计非常符合Agent 需要在循环内执行的情况。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">AgentState</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Defines possible states during an agent&#39;s execution lifecycle.&#34;&#34;&#34;</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="n">IDLE</span> <span class="o">=</span> <span class="s2">&#34;idle&#34;</span>  
</span></span><span class="line"><span class="cl">    <span class="n">RUNNING</span> <span class="o">=</span> <span class="s2">&#34;running&#34;</span>  
</span></span><span class="line"><span class="cl">    <span class="n">COMPLETED</span> <span class="o">=</span> <span class="s2">&#34;completed&#34;</span>  
</span></span><span class="line"><span class="cl">    <span class="n">ERROR</span> <span class="o">=</span> <span class="s2">&#34;error&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">AgentStepState</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Defines possible states during an agent&#39;s execution lifecycle.&#34;&#34;&#34;</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="n">THINKING</span> <span class="o">=</span> <span class="s2">&#34;thinking&#34;</span>  
</span></span><span class="line"><span class="cl">    <span class="n">CALLING_TOOL</span> <span class="o">=</span> <span class="s2">&#34;calling_tool&#34;</span>  
</span></span><span class="line"><span class="cl">    <span class="n">REFLECTING</span> <span class="o">=</span> <span class="s2">&#34;reflecting&#34;</span>  
</span></span><span class="line"><span class="cl">    <span class="n">COMPLETED</span> <span class="o">=</span> <span class="s2">&#34;completed&#34;</span>  
</span></span><span class="line"><span class="cl">    <span class="n">ERROR</span> <span class="o">=</span> <span class="s2">&#34;error&#34;</span>  
</span></span></code></pre></div><p>AgentState 状态扭转</p>
<pre class="mermaid">
    stateDiagram-v2
    [*] --&gt; IDLE
    IDLE --&gt; RUNNING: 开始执行任务
    RUNNING --&gt; COMPLETED: 任务成功完成
    RUNNING --&gt; ERROR: 执行发生错误
    COMPLETED --&gt; [*]
    ERROR --&gt; [*]
    
    note right of RUNNING: 在此状态下执行多个步骤
  </pre>
  <p>AgentStepState 状态扭转</p>
<pre class="mermaid">
    stateDiagram-v2
    [*] --&gt; THINKING
    THINKING --&gt; CALLING_TOOL: LLM决定调用工具
    THINKING --&gt; COMPLETED: LLM决定任务完成
    CALLING_TOOL --&gt; REFLECTING: 工具执行有问题需要反思
    CALLING_TOOL --&gt; COMPLETED: 工具执行成功
    REFLECTING --&gt; COMPLETED: 反思完成
    THINKING --&gt; ERROR: 推理过程出错
    CALLING_TOOL --&gt; ERROR: 工具调用出错
    REFLECTING --&gt; ERROR: 反思过程出错
    COMPLETED --&gt; [*]
    ERROR --&gt; [*]
  </pre>
  <h2 id="工具">工具</h2>
<p>Trae Agent 内置了下面工具</p>
<ul>
<li>CKG：代码知识图谱</li>
<li>Bash</li>
<li>Docker tool Execute</li>
<li>Edit</li>
<li>Json Edit：专门为 json 文件编辑设计</li>
<li>MCP</li>
<li>Sequential Thinking Tool：思考工具</li>
<li>Task Done： 虚拟工具，用于标记任务结束</li>
</ul>
<p>工具基类以及工具参数设计：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Tool</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Base class for all tools.&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="o">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@abstractmethod</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Get the tool name.&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">pass</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@abstractmethod</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_description</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Get the tool description.&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">pass</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@abstractmethod</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">ToolParameter</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Get the tool parameters.&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">pass</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@abstractmethod</span>
</span></span><span class="line"><span class="cl">    <span class="k">async</span> <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arguments</span><span class="p">:</span> <span class="n">ToolCallArguments</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ToolExecResult</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Execute the tool with given parameters.&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">pass</span>
</span></span><span class="line"><span class="cl">	<span class="o">...</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl"><span class="nd">@dataclass</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">ToolParameter</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Tool parameter definition.&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">enum</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">    <span class="n">items</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">    <span class="n">required</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
</span></span></code></pre></div><p>每个工具的实现需要实现下面方法</p>
<ul>
<li>get_name：工具标识，用于获取工具实例</li>
<li>get_description：工具描述，用于LLM 调用中的 Function Call</li>
<li>get_parameters：工具参数集合</li>
<li>execute：工具执行逻辑</li>
</ul>
<h3 id="ckg-tool">CKG Tool</h3>
<p>CKG 为代码知识图谱工具，用于构建和查询代码库的结构化信息。它提供三个核心功能：</p>
<ul>
<li>search_function: 搜索函数定义</li>
<li>search_class: 搜索类定义</li>
<li>search_class_method: 搜索类方法</li>
</ul>
<p>用于解决下面这几类问题</p>
<ul>
<li>代码理解: 快速定位函数和类的定义</li>
<li>代码导航: 找到具体的实现位置和行号</li>
<li>上下文分析: 了解函数/类的完整代码和结构信息</li>
</ul>
<h4 id="ckg-schema">CKG Schema</h4>
<p>Agent 会为每一个代码仓库快照构建一个database， 储存于本地的 sqlite，表结构如下</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">-- 函数表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">functions</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="n">id</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="n">NAME</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w"> </span><span class="c1">-- 函数名
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">	</span><span class="n">file_path</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w"> </span><span class="c1">-- 文件路径
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">	</span><span class="n">body</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w"> </span><span class="c1">-- 函数体代码
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">	</span><span class="n">start_line</span><span class="w"> </span><span class="nb">INTEGER</span><span class="p">,</span><span class="w"> </span><span class="c1">-- 起始行号
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">	</span><span class="n">end_line</span><span class="w"> </span><span class="nb">INTEGER</span><span class="p">,</span><span class="w"> </span><span class="c1">-- 结束行号
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">	</span><span class="n">parent_function</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span><span class="w"> </span><span class="c1">-- 父函数（嵌套函数）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">	</span><span class="n">parent_class</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="c1">-- 所属类（方法）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 类表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">classes</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="n">id</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="n">NAME</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w"> </span><span class="c1">-- 类名
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">	</span><span class="n">file_path</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w"> </span><span class="c1">-- 文件路径
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">	</span><span class="n">body</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w"> </span><span class="c1">-- 类体代码
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">	</span><span class="n">fields</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span><span class="w"> </span><span class="c1">-- 字段列表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">	</span><span class="n">methods</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span><span class="w"> </span><span class="c1">-- 方法列表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">	</span><span class="n">start_line</span><span class="w"> </span><span class="nb">INTEGER</span><span class="p">,</span><span class="w"> </span><span class="c1">-- 起始行号
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">	</span><span class="n">end_line</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="c1">-- 结束行号
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><h4 id="构建逻辑">构建逻辑</h4>
<p>CKG 会在 Agent 初始化时执行预清理清除旧的数据库，在工具被首次执行的时候懒加载，构建流程如下图。
构建时会以代码库的快照哈希判断是否需要重建。
代码库的快照哈希</p>
<ul>
<li>Git 仓库：基于 commit + 未提交变更</li>
<li>非 Git：基于文件元数据（文件名+修改时间+文件大小）</li>
</ul>
<pre class="mermaid">
    sequenceDiagram
    participant Client as 客户端
    participant CKG as CKGDatabase
    participant FS as 文件系统
    participant Git as Git命令
    participant DB as SQLite数据库

    Note over Client,DB: CKG 数据库初始化流程

    Client-&gt;&gt;CKG: __init__(codebase_path)
    
    Note over CKG: 1. 初始化阶段
    CKG-&gt;&gt;CKG: 设置 _codebase_path
    CKG-&gt;&gt;FS: 检查 CKG_DATABASE_PATH 目录
    alt 目录不存在
        CKG-&gt;&gt;FS: mkdir(parents=True, exist_ok=True)
    end

    Note over CKG: 2. 读取存储信息
    CKG-&gt;&gt;FS: 检查 CKG_STORAGE_INFO_FILE 是否存在
    alt 存储信息文件存在
        CKG-&gt;&gt;FS: 读取 storage_info.json
        FS--&gt;&gt;CKG: 返回 ckg_storage_info 字典
        alt 当前路径在存储信息中
            CKG-&gt;&gt;CKG: existing_hash = ckg_storage_info[path]
        else 路径不存在
            CKG-&gt;&gt;CKG: existing_hash = &#34;&#34;
        end
    else 存储信息文件不存在
        CKG-&gt;&gt;CKG: existing_hash = &#34;&#34;
    end

    Note over CKG: 3. 计算当前快照哈希
    CKG-&gt;&gt;Git: get_folder_snapshot_hash(codebase_path)
    alt 是 Git 仓库
        Git-&gt;&gt;Git: 获取 commit hash + 未提交变更
        Git--&gt;&gt;CKG: current_hash (git-clean-xxx 或 git-dirty-xxx)
    else 非 Git 仓库
        Git-&gt;&gt;FS: 计算文件元数据哈希
        FS--&gt;&gt;CKG: current_hash (metadata-xxx)
    end

    Note over CKG: 4. 比较哈希值并决策
    alt existing_hash == current_hash
        Note over CKG: 可以复用现有数据库
        CKG-&gt;&gt;CKG: database_path = get_ckg_database_path(existing_hash)
    else 哈希值不同或为空
        Note over CKG: 需要重建数据库
        CKG-&gt;&gt;CKG: old_db_path = get_ckg_database_path(existing_hash)
        alt 旧数据库存在
            CKG-&gt;&gt;FS: 删除旧数据库文件
        end
        CKG-&gt;&gt;CKG: database_path = get_ckg_database_path(current_hash)
        CKG-&gt;&gt;CKG: 更新 ckg_storage_info[path] = current_hash
        CKG-&gt;&gt;FS: 保存更新后的 storage_info.json
    end

    Note over CKG: 5. 连接/创建数据库
    alt 数据库文件存在
        Note over CKG: 复用现有数据库
        CKG-&gt;&gt;DB: sqlite3.connect(database_path)
        DB--&gt;&gt;CKG: 数据库连接
    else 数据库文件不存在
        Note over CKG: 创建新数据库
        CKG-&gt;&gt;DB: sqlite3.connect(database_path)
        DB--&gt;&gt;CKG: 数据库连接
        
        loop 创建表结构
            CKG-&gt;&gt;DB: execute(CREATE TABLE functions...)
            CKG-&gt;&gt;DB: execute(CREATE TABLE classes...)
        end
        CKG-&gt;&gt;DB: commit()
        
        Note over CKG: 构建代码知识图谱
        CKG-&gt;&gt;CKG: _construct_ckg()
        
        Note over CKG,FS: 遍历代码文件，解析AST，插入数据库
        loop 处理每个代码文件
            CKG-&gt;&gt;FS: 读取源文件
            CKG-&gt;&gt;CKG: tree-sitter 解析 AST
            CKG-&gt;&gt;DB: 插入函数/类信息
        end
    end

    CKG--&gt;&gt;Client: 初始化完成，返回 CKGDatabase 实例
  </pre>
  <p>目前支持部分语言构建代码知识图谱：</p>
<ul>
<li>python</li>
<li>Java</li>
<li>Cpp</li>
<li>C</li>
<li>Typescript</li>
<li>Javascript</li>
</ul>
<h3 id="bash--tool">Bash  Tool</h3>
<p>Trae Agent 提供了 bash 工具，支持在 Unix 和 Windows 下工作。通过 bash shell 工具，可以支持执行各种复杂命令以及持久化会话状态。</p>
<pre class="mermaid">
    sequenceDiagram
    participant A as Agent
    participant BT as BashTool  
    participant BS as BashSession
    participant P as Process
    
    A-&gt;&gt;BT: execute(command)
    BT-&gt;&gt;BT: 检查session
    
    alt session不存在
        BT-&gt;&gt;BS: 创建新session
        BS-&gt;&gt;P: 启动bash进程
        P--&gt;&gt;BS: 进程创建成功
    end
    
    BT-&gt;&gt;BS: run(command)
    BS-&gt;&gt;BS: 构造sentinel
    BS-&gt;&gt;P: 发送包装后的命令
    
    loop 轮询输出
        BS-&gt;&gt;P: 读取stdout缓冲区
        P--&gt;&gt;BS: 返回当前输出
        
        alt 找到sentinel
            BS-&gt;&gt;BS: 解析输出和错误码
        else 超时
            BS-&gt;&gt;BS: 设置超时状态
        end
    end
    
    BS-&gt;&gt;P: 读取stderr
    P--&gt;&gt;BS: 返回错误信息
    
    BS--&gt;&gt;BT: 返回结果
    BT--&gt;&gt;A: 返回ToolExecResult
  </pre>
  <h4 id="sentinel机制">Sentinel机制</h4>
<p>因为 bash shell 是一直存在于 task 声明周期内的，并不是一次执行，所以需要一个标记机制用于获取命令的输出。
通过在执行命令后面附加 <code>echo sentinel</code> ，可以通过sentinel 标识区分获取任务的结束输出以及错误码。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">_sentinel</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&#34;,,,,bash-command-exit-__ERROR_CODE__-banner,,,,&#34;</span> <span class="c1"># `__ERROR_CODE__` will be replaced by `$?` or `!errorlevel!` later</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">sentinel_before</span><span class="p">,</span> <span class="n">pivot</span><span class="p">,</span> <span class="n">sentinel_after</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sentinel</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s2">&#34;__ERROR_CODE__&#34;</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="k">assert</span> <span class="n">pivot</span> <span class="o">==</span> <span class="s2">&#34;__ERROR_CODE__&#34;</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="n">errcode_retriever</span> <span class="o">=</span> <span class="s2">&#34;!errorlevel!&#34;</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&#34;nt&#34;</span> <span class="k">else</span> <span class="s2">&#34;$?&#34;</span>  
</span></span><span class="line"><span class="cl"><span class="n">command_sep</span> <span class="o">=</span> <span class="s2">&#34;&amp;&#34;</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&#34;nt&#34;</span> <span class="k">else</span> <span class="s2">&#34;;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># send command to the process  </span>
</span></span><span class="line"><span class="cl"><span class="bp">self</span><span class="o">.</span><span class="n">_process</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>  
</span></span><span class="line"><span class="cl">    <span class="sa">b</span><span class="s2">&#34;(</span><span class="se">\n</span><span class="s2">&#34;</span>  
</span></span><span class="line"><span class="cl">    <span class="o">+</span> <span class="n">command</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">    <span class="o">+</span> <span class="sa">f</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">)</span><span class="si">{</span><span class="n">command_sep</span><span class="si">}</span><span class="s2"> echo </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_sentinel</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;__ERROR_CODE__&#39;</span><span class="p">,</span> <span class="n">errcode_retriever</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl"><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">drain</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="c1"># read output from the process, until the sentinel is found  </span>
</span></span><span class="line"><span class="cl"><span class="k">try</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">    <span class="k">async</span> <span class="k">with</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_timeout</span><span class="p">):</span>  
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_delay</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">            <span class="c1"># if we read directly from stdout/stderr, it will wait forever for  </span>
</span></span><span class="line"><span class="cl">            <span class="c1"># EOF. use the StreamReader buffer directly instead.            output: str = self._process.stdout._buffer.decode()  # type: ignore[attr-defined] # pyright: ignore[reportAttributeAccessIssue, reportUnknownMemberType, reportUnknownVariableType]  </span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">sentinel_before</span> <span class="ow">in</span> <span class="n">output</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">                <span class="c1"># strip the sentinel from output  </span>
</span></span><span class="line"><span class="cl">                <span class="n">output</span><span class="p">,</span> <span class="n">pivot</span><span class="p">,</span> <span class="n">exit_banner</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">rpartition</span><span class="p">(</span><span class="n">sentinel_before</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">                <span class="k">assert</span> <span class="n">pivot</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">                <span class="c1"># get error code inside banner  </span>
</span></span><span class="line"><span class="cl">                <span class="n">error_code_str</span><span class="p">,</span> <span class="n">pivot</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">exit_banner</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="n">sentinel_after</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="ow">not</span> <span class="n">pivot</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">error_code_str</span><span class="o">.</span><span class="n">isdecimal</span><span class="p">():</span>  
</span></span><span class="line"><span class="cl">                    <span class="k">continue</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">                <span class="n">error_code</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">error_code_str</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">                <span class="k">break</span>  
</span></span><span class="line"><span class="cl"><span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">TimeoutError</span><span class="p">:</span>  
</span></span><span class="line"><span class="cl">    <span class="bp">self</span><span class="o">.</span><span class="n">_timed_out</span> <span class="o">=</span> <span class="kc">True</span>  
</span></span><span class="line"><span class="cl">    <span class="k">raise</span> <span class="n">ToolError</span><span class="p">(</span>  
</span></span><span class="line"><span class="cl">        <span class="sa">f</span><span class="s2">&#34;timed out: bash has not returned in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_timeout</span><span class="si">}</span><span class="s2"> seconds and must be restarted&#34;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">    <span class="p">)</span> <span class="kn">from</span> <span class="bp">None</span>
</span></span></code></pre></div><h3 id="edit-tool">Edit Tool</h3>
<p>Edit Tool 其实文件交互工具，不仅仅包含编辑文件的功能，还提供了查看文件的功能，提供下面模式命令</p>
<ul>
<li>view：查看文件内容，支持指定范围</li>
<li>create：创建文件并写入</li>
<li>str_replace：替换文件中的指定内容
<ul>
<li>注意：当替换内容在文件出现多次时会报错提示 LLM</li>
</ul>
</li>
<li>insert：在文件指定行处插入内容</li>
</ul>
<p>该工具的实现并不复杂，这里不展开讲解具体逻辑。</p>
<h4 id="文件路径校验">文件路径校验</h4>
<p>路径参数只支持绝对路径，报错还会给出可能的路径。基本上所有的 coding agent 的实现都推荐使用绝对路径作为工具参数。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">validate_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Path</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">	<span class="s2">&#34;&#34;&#34;Validate the path for the str_replace_editor tool.&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">is_absolute</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">		<span class="n">suggested_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&#34;/&#34;</span><span class="p">)</span> <span class="o">/</span> <span class="n">path</span>
</span></span><span class="line"><span class="cl">		<span class="k">raise</span> <span class="n">ToolError</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">			<span class="sa">f</span><span class="s2">&#34;The path </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2"> is not an absolute path, it should start with `/`. Maybe you meant </span><span class="si">{</span><span class="n">suggested_path</span><span class="si">}</span><span class="s2">?&#34;</span>
</span></span><span class="line"><span class="cl">		<span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="c1"># Check if path exists</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="n">command</span> <span class="o">!=</span> <span class="s2">&#34;create&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="k">raise</span> <span class="n">ToolError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;The path </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2"> does not exist. Please provide a valid path.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="n">command</span> <span class="o">==</span> <span class="s2">&#34;create&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="k">raise</span> <span class="n">ToolError</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">			<span class="sa">f</span><span class="s2">&#34;File already exists at: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">. Cannot overwrite files using command `create`.&#34;</span>
</span></span><span class="line"><span class="cl">		<span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="c1"># Check if the path points to a directory</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">is_dir</span><span class="p">()</span> <span class="ow">and</span> <span class="n">command</span> <span class="o">!=</span> <span class="s2">&#34;view&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="k">raise</span> <span class="n">ToolError</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">			<span class="sa">f</span><span class="s2">&#34;The path </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2"> is a directory and only the `view` command can be used on directories&#34;</span>
</span></span><span class="line"><span class="cl">		<span class="p">)</span>
</span></span></code></pre></div><h4 id="结果输出">结果输出</h4>
<p>在工具完成任务后会输出相对友好的改动范围，作为工具输出反馈给LLM ，还可以用于 UI 展示</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">str_replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">old_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">new_str</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ToolExecResult</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	<span class="o">...</span> <span class="c1"># 文件内容替换</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1"># Create a snippet of the edited section</span>
</span></span><span class="line"><span class="cl">	<span class="n">replacement_line</span> <span class="o">=</span> <span class="n">file_content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">old_str</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">start_line</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">replacement_line</span> <span class="o">-</span> <span class="n">SNIPPET_LINES</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">end_line</span> <span class="o">=</span> <span class="n">replacement_line</span> <span class="o">+</span> <span class="n">SNIPPET_LINES</span> <span class="o">+</span> <span class="n">new_str</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">snippet</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_file_content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)[</span><span class="n">start_line</span> <span class="p">:</span> <span class="n">end_line</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1"># Prepare the success message</span>
</span></span><span class="line"><span class="cl">	<span class="n">success_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;The file </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2"> has been edited. &#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">success_msg</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_output</span><span class="p">(</span><span class="n">snippet</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&#34;a snippet of </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">start_line</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">success_msg</span> <span class="o">+=</span> <span class="s2">&#34;Review the changes and make sure they are as expected. Edit the file again if necessary.&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">ToolExecResult</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">		<span class="n">output</span><span class="o">=</span><span class="n">success_msg</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">_make_output</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="bp">self</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="n">file_content</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="n">file_descriptor</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="n">init_line</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="n">expand_tabs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">):</span>
</span></span><span class="line"><span class="cl">	<span class="s2">&#34;&#34;&#34;Generate output for the CLI based on the content of a file.&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="n">file_content</span> <span class="o">=</span> <span class="n">maybe_truncate</span><span class="p">(</span><span class="n">file_content</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="n">expand_tabs</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="n">file_content</span> <span class="o">=</span> <span class="n">file_content</span><span class="o">.</span><span class="n">expandtabs</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="n">file_content</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">		<span class="p">[</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">i</span> <span class="o">+</span> <span class="n">init_line</span><span class="si">:</span><span class="s2">6</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">line</span><span class="si">}</span><span class="s2">&#34;</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">file_content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">))]</span>
</span></span><span class="line"><span class="cl">	<span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">		<span class="sa">f</span><span class="s2">&#34;Here&#39;s the result of running `cat -n` on </span><span class="si">{</span><span class="n">file_descriptor</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">&#34;</span> <span class="o">+</span> <span class="n">file_content</span> <span class="o">+</span> <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="p">)</span>
</span></span></code></pre></div><h3 id="sequential-thinking-tool">Sequential Thinking Tool</h3>
<p>顺序思考工具 ，在 trae-agent 中用于帮助 AI 进行结构化思考和问题分解的工具。</p>
<h4 id="prompt">Prompt</h4>
<p>工具的描述即是 Prompt 的 一部分，引导 LLM 进行反思推理。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">A detailed tool <span class="k">for</span> dynamic and reflective problem-solving through thoughts.
</span></span><span class="line"><span class="cl">This tool helps analyze problems through a flexible thinking process that can adapt and evolve.
</span></span><span class="line"><span class="cl">Each thought can build on, question, or revise previous insights as understanding deepens.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">When to use this tool:
</span></span><span class="line"><span class="cl">- Breaking down complex problems into steps
</span></span><span class="line"><span class="cl">- Planning and design with room <span class="k">for</span> revision
</span></span><span class="line"><span class="cl">- Analysis that might need course correction
</span></span><span class="line"><span class="cl">- Problems where the full scope might not be clear initially
</span></span><span class="line"><span class="cl">- Problems that require a multi-step solution
</span></span><span class="line"><span class="cl">- Tasks that need to maintain context over multiple steps
</span></span><span class="line"><span class="cl">- Situations where irrelevant information needs to be filtered out
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Key features:
</span></span><span class="line"><span class="cl">- You can adjust total_thoughts up or down as you progress
</span></span><span class="line"><span class="cl">- You can question or revise previous thoughts
</span></span><span class="line"><span class="cl">- You can add more thoughts even after reaching what seemed like the end
</span></span><span class="line"><span class="cl">- You can express uncertainty and explore alternative approaches
</span></span><span class="line"><span class="cl">- Not every thought needs to build linearly - you can branch or backtrack
</span></span><span class="line"><span class="cl">- Generates a solution hypothesis
</span></span><span class="line"><span class="cl">- Verifies the hypothesis based on the Chain of Thought steps
</span></span><span class="line"><span class="cl">- Repeats the process <span class="k">until</span> satisfied
</span></span><span class="line"><span class="cl">- Provides a correct answer
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Parameters explained:
</span></span><span class="line"><span class="cl">- thought: Your current thinking step, which can include:
</span></span><span class="line"><span class="cl">* Regular analytical steps
</span></span><span class="line"><span class="cl">* Revisions of previous thoughts
</span></span><span class="line"><span class="cl">* Questions about previous decisions
</span></span><span class="line"><span class="cl">* Realizations about needing more analysis
</span></span><span class="line"><span class="cl">* Changes in approach
</span></span><span class="line"><span class="cl">* Hypothesis generation
</span></span><span class="line"><span class="cl">* Hypothesis verification
</span></span><span class="line"><span class="cl">- next_thought_needed: True <span class="k">if</span> you need more thinking, even <span class="k">if</span> at what seemed like the end
</span></span><span class="line"><span class="cl">- thought_number: Current number in sequence <span class="o">(</span>can go beyond initial total <span class="k">if</span> needed<span class="o">)</span>
</span></span><span class="line"><span class="cl">- total_thoughts: Current estimate of thoughts needed <span class="o">(</span>can be adjusted up/down<span class="o">)</span>
</span></span><span class="line"><span class="cl">- is_revision: A boolean indicating <span class="k">if</span> this thought revises previous thinking
</span></span><span class="line"><span class="cl">- revises_thought: If is_revision is true, which thought number is being reconsidered
</span></span><span class="line"><span class="cl">- branch_from_thought: If branching, which thought number is the branching point
</span></span><span class="line"><span class="cl">- branch_id: Identifier <span class="k">for</span> the current branch <span class="o">(</span><span class="k">if</span> any<span class="o">)</span>
</span></span><span class="line"><span class="cl">- needs_more_thoughts: If reaching end but realizing more thoughts needed
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">You should:
</span></span><span class="line"><span class="cl">1. Start with an initial estimate of needed thoughts, but be ready to adjust
</span></span><span class="line"><span class="cl">2. Feel free to question or revise previous thoughts
</span></span><span class="line"><span class="cl">3. Don<span class="err">&#39;</span>t hesitate to add more thoughts <span class="k">if</span> needed, even at the <span class="s2">&#34;end&#34;</span>
</span></span><span class="line"><span class="cl">4. Express uncertainty when present
</span></span><span class="line"><span class="cl">5. Mark thoughts that revise previous thinking or branch into new paths
</span></span><span class="line"><span class="cl">6. Ignore information that is irrelevant to the current step
</span></span><span class="line"><span class="cl">7. Generate a solution hypothesis when appropriate
</span></span><span class="line"><span class="cl">8. Verify the hypothesis based on the Chain of Thought steps
</span></span><span class="line"><span class="cl">9. Repeat the process <span class="k">until</span> satisfied with the solution
</span></span><span class="line"><span class="cl">10. Provide a single, ideally correct answer as the final output
</span></span><span class="line"><span class="cl">11. Only <span class="nb">set</span> next_thought_needed to <span class="nb">false</span> when truly <span class="k">done</span> and a satisfactory answer is reached
</span></span></code></pre></div><h4 id="结构化思考">结构化思考</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="nd">@dataclass</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">ThoughtData</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	<span class="n">thought</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">	<span class="n">thought_number</span><span class="p">:</span> <span class="nb">int</span>
</span></span><span class="line"><span class="cl">	<span class="n">total_thoughts</span><span class="p">:</span> <span class="nb">int</span>
</span></span><span class="line"><span class="cl">	<span class="n">next_thought_needed</span><span class="p">:</span> <span class="nb">bool</span>
</span></span><span class="line"><span class="cl">	<span class="n">is_revision</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">	<span class="n">revises_thought</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">	<span class="n">branch_from_thought</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">	<span class="n">branch_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">	<span class="n">needs_more_thoughts</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span></span></code></pre></div><p>参数解释（其实就是对应上面 Prompt 部分的翻译）:</p>
<ul>
<li>thought: 您当前思考步骤，可以包括：
<ul>
<li>常规分析步骤</li>
<li>对先前想法的修订</li>
<li>对先前决策的疑问</li>
<li>关于需要更多分析的领悟</li>
<li>方法的变化</li>
<li>假设的生成</li>
<li>假设的验证</li>
</ul>
</li>
<li>next_thought_needed: 需要更多思考时为True，即使看似已经结束</li>
<li>thought_number: 当前序列中的编号（如有需要，可以超过初始总数）</li>
<li>total_thoughts: 当前所需思考的估计（可上下调整）</li>
<li>is_revision: 一个布尔值，表示此想法是否修订了先前的思考</li>
<li>revises_thought: 如果is_revision为true，则正在重新考虑的想法编号</li>
<li>branch_from_thought: 如果分支，则分支点的想法编号</li>
<li>branch_id: 当前分支的标识符（如果有）</li>
<li>needs_more_thoughts: 如果到达终点但意识到需要更多思考</li>
</ul>
<p><strong>这个思考工具通过结构化的设计（强校验）以及引入序列版本号、分支、修订机制让 LLM 的推理更加强大，可以追溯之前的思路一步步演进和返工重来。</strong></p>
<h2 id="评估">评估</h2>
<h3 id="swe-bench">SWE Bench</h3>
<p>Trae agent 里面使用了 <a href="https://www.swebench.com/">SWE-bench</a>, <a href="https://swe-bench-live.github.io/">SWE-bench-Live</a>, 和 <a href="https://multi-swe-bench.github.io/">Multi-SWE-bench</a> 数据集来测试评估 agent 解决软件工程问题的能力</p>
<p>SWE 测试评估流程 如下</p>
<pre class="mermaid">
    graph TD
    A[GitHub 真实问题] --&gt; B[SWE-bench 数据集]
    B --&gt; C[Docker 环境 + 源代码]
    C --&gt; D[Trae Agent 分析问题]
    D --&gt; E[生成代码补丁]
    E --&gt; F[应用补丁到源代码]
    F --&gt; G[运行自动化测试]
    G --&gt; H{测试是否通过?}
    H --&gt;|通过| I[✅ 问题解决]
    H --&gt;|失败| J[❌ 补丁无效]
    
    I --&gt; K[计算成功率指标]
    J --&gt; K
    
    style A fill:#e1f5fe
    style E fill:#fff3e0
    style G fill:#f3e5f5
    style I fill:#e8f5e8
    style J fill:#ffebee
  </pre>
  <p>除了该评估外，Trae agent 还实现了一个 patch selection</p>
<h3 id="patch-selection">Patch Selection</h3>
<p>项目里提供了一个 Selector Agent， 该 Agent 在多个候选补丁（ 使用 Trae Agent 生成）中进行剪枝，投票等流程，最终选出一个最合理的补丁，以提供解决问题的能力。</p>
<p><img src="/img/trae_agent_read/1.png" alt=""></p>
<p>技术报告：<a href="https://arxiv.org/html/2507.23370?_immersive_translate_auto_translate=1"># Trae Agent: An LLM-based Agent for Software Engineering with Test-time Scaling</a></p>
<h4 id="prompt-1">Prompt</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-markdown" data-lang="markdown"><span class="line"><span class="cl"><span class="gh"># ROLE: Act as an expert code evaluator. Given a codebase, an github issue and **{candidate_length} candidate patches** proposed by your colleagues, your responsibility is to **select the correct one** to solve the issue.
</span></span></span><span class="line"><span class="cl"><span class="gh"></span>
</span></span><span class="line"><span class="cl"><span class="gh"># WORK PROCESS:
</span></span></span><span class="line"><span class="cl"><span class="gh"></span>You are given a software issue and multiple candidate patches. Your goal is to identify the patch that correctly resolves the issue.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Follow these steps methodically:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="gs">**1. Understand the Issue and Codebase**</span>
</span></span><span class="line"><span class="cl">Carefully read the issue description to comprehend the problem. You may need to examine the codebase for context, including:
</span></span><span class="line"><span class="cl">    (1) Code referenced in the issue description;
</span></span><span class="line"><span class="cl">    (2) The original code modified by each patch;
</span></span><span class="line"><span class="cl">    (3) Unchanged parts of the same file;
</span></span><span class="line"><span class="cl">    (4) Related files, functions, or modules that interact with the affected code.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="gs">**2. Analyze the Candidate Patches**</span>
</span></span><span class="line"><span class="cl">For each patch, analyze its logic and intended fix. Consider whether the changes align with the issue description and coding conventions.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="gs">**3. Validate Functionality (Optional but Recommended)**</span>
</span></span><span class="line"><span class="cl">If needed, write and run unit tests to evaluate the correctness and potential side effects of each patch.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="gs">**4. Select the Best Patch**</span>
</span></span><span class="line"><span class="cl">Choose the patch that best resolves the issue with minimal risk of introducing new problems.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="gh"># FINAL REPORT: If you have successfully selected the correct patch, submit your answer in the following format:
</span></span></span><span class="line"><span class="cl"><span class="gh"></span><span class="gu">### Status: succeed
</span></span></span><span class="line"><span class="cl"><span class="gu">### Result: Patch-x
</span></span></span><span class="line"><span class="cl"><span class="gu">### Analysis: [Explain why Patch-x is correct.]
</span></span></span><span class="line"><span class="cl"><span class="gu"></span>
</span></span><span class="line"><span class="cl"><span class="gh"># IMPORTANT TIPS:
</span></span></span><span class="line"><span class="cl"><span class="gh"></span><span class="k">1.</span> Never avoid making a selection.
</span></span><span class="line"><span class="cl"><span class="k">2.</span> Do not propose new patches.
</span></span><span class="line"><span class="cl"><span class="k">3.</span> There must be at least one correct patch.
</span></span></code></pre></div><h4 id="核心流程-1">核心流程</h4>
<pre class="mermaid">
    flowchart TD
    A[读取 SWE-bench 实例\ninstances.json] --&gt; B[载入候选补丁\ncandidate.jsonl]
    B --&gt; C{按 group_size\n分组候选}
    C --&gt;|全对/全错| D[直接记录结果\n保存补丁/状态]
    C --&gt;|需要评估| E[预处理候选\n清洗/去重/回归过滤]
    E --&gt; F[启动 Sandbox\n准备仓库环境]
    F --&gt; G{majority_voting?}
    G --&gt;|是| H[多轮调用 SelectorAgent\n直至某补丁过半]
    G --&gt;|否| I[单次调用 SelectorAgent]
    H --&gt; J[确定最终补丁 ID/内容]
    I --&gt; J
    J --&gt; K[保存补丁内容\npatch/]
    J --&gt; L[记录统计信息\nstatistics/]
    F --&gt; M[LLM 交互日志\nlog/]
    F --&gt; N[标准输出/错误\noutput/]
  </pre>
  <ul>
<li>剪枝&amp;去重：使用 <code>Agentless</code> 为候选补丁生成是否回归测试是否通过标识，可以在剪枝流程过滤掉失败的补丁减少候选集。同时会使用 <code>clean_patch</code> 方法格式化候选集中的补丁来去重</li>
<li>投票：在经过剪枝&amp;去重的候选集中进行 LLM 投票，选择中获票次数最高的补丁</li>
</ul>
<p>投票策略</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># majority voting</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="n">majority_voting</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	<span class="n">final_id_list</span><span class="p">,</span> <span class="n">final_patch_list</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_candidate</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">		<span class="n">select_agent</span> <span class="o">=</span> <span class="n">SelectorAgent</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">			<span class="n">llm_config</span><span class="o">=</span><span class="n">llm_config</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="n">sandbox</span><span class="o">=</span><span class="n">sandbox</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="n">project_path</span><span class="o">=</span><span class="n">project_path</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="n">issue_description</span><span class="o">=</span><span class="n">instance</span><span class="p">[</span><span class="s2">&#34;problem_statement&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">			<span class="n">trajectory_file_name</span><span class="o">=</span><span class="n">get_trajectory_filename</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">				<span class="n">instance</span><span class="p">[</span><span class="s2">&#34;instance_id&#34;</span><span class="p">],</span> <span class="n">log_path</span><span class="p">,</span> <span class="n">group_id</span><span class="p">,</span> <span class="n">idx</span>
</span></span><span class="line"><span class="cl">			<span class="p">),</span>
</span></span><span class="line"><span class="cl">			<span class="n">candidate_list</span><span class="o">=</span><span class="n">candidate_list</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="n">max_turn</span><span class="o">=</span><span class="n">max_turn</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">final_id</span><span class="p">,</span> <span class="n">final_patch</span> <span class="o">=</span> <span class="n">select_agent</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="n">final_id_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">final_id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="n">final_patch_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">final_patch</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">Counter</span><span class="p">(</span><span class="n">final_id_list</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">&gt;</span> <span class="n">num_candidate</span> <span class="o">/</span> <span class="mi">2</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span>
</span></span><span class="line"><span class="cl">	<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;[Retry No:</span><span class="si">{</span><span class="n">current_try</span><span class="si">}</span><span class="s2">] majority voting done&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">counter</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">final_id_list</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">max_count</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">counter</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">	<span class="n">most_common_ids</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">		<span class="n">elem</span> <span class="k">for</span> <span class="n">elem</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">counter</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="n">max_count</span>
</span></span><span class="line"><span class="cl">	<span class="p">]</span>
</span></span><span class="line"><span class="cl">	<span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="n">id_</span> <span class="ow">in</span> <span class="n">most_common_ids</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="n">indexes</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">final_id_list</span><span class="p">)</span> <span class="k">if</span> <span class="n">val</span> <span class="o">==</span> <span class="n">id_</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">		<span class="n">result</span><span class="p">[</span><span class="n">id_</span><span class="p">]</span> <span class="o">=</span> <span class="n">indexes</span>
</span></span><span class="line"><span class="cl">	<span class="n">final_id</span> <span class="o">=</span> <span class="n">most_common_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">	<span class="n">final_patch</span> <span class="o">=</span> <span class="n">final_patch_list</span><span class="p">[</span><span class="n">result</span><span class="p">[</span><span class="n">final_id</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">	<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;[Retry No:</span><span class="si">{</span><span class="n">current_try</span><span class="si">}</span><span class="s2">] final_id_list: </span><span class="si">{</span><span class="n">final_id_list</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
</span></span></code></pre></div><p>当某个候选补丁获得的票数超过一半，提前退出投票流程。否则在最多相同票数中选出第一个。</p>
</div><div class="flex flex-col items-center justify-center" style="min-height:120px;">
  <p style="opacity: 0.5; font-size: 0.8rem; color: #888;">-- End --</p>
</div>
  
    <div class="mt-16">

</div>
  
</article>
      </div>
    </main><footer class="fixed left-0 bottom-0 w-full bg-base px-page-gutter">
  <div class="flex justify-center items-center h-footer-height">
    <div
      class="flex flex-row w-full max-w-content justify-between lowercase italic gap-3"
    >
      <nav>
        <a href="http://localhost:1313//index.xml"
          ><svg
            width="18px"
            height="18px"
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="1.5"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M12.75 19.5v-.75a7.5 7.5 0 00-7.5-7.5H4.5m0-6.75h.75c7.87 0 14.25 6.38 14.25 14.25v.75M6 18.75a.75.75 0 11-1.5 0 .75.75 0 011.5 0z"
            />
          </svg>
        </a>
      </nav>
      <span class="text-muted hidden md:block">
        &copy;
        2025 Mingheng Lu
        Powered by 
        <a
          href="https://github.com/ntk148v/hugo-toigian"
          class="font-bold hover:underline"
          >hugo-toigian</a
        >
      </span>      
      <div id="header-theme-button">
        <svg
          id="dark_mode_btn"
          class="hidden toolbox-btn"
          width="18px"
          height="18px"
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          stroke-width="1.5"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z"
          />
        </svg>
        <svg
          id="light_mode_btn"
          class="hidden toolbox-btn"
          width="18px"
          height="18px"
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          stroke-width="1.5"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z"
          />
        </svg>
      </div>
    </div>
  </div>
</footer>
</body>
</html>
